<!DOCTYPE html>
<html lang="ru">
<head>
  <link rel="icon" href="data:image/x-icon;base64,AAABAAEAEBAQAAAAAAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAA//8A">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ—Å–∫–∞</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
      min-height: 100vh;
      overflow-x: hidden;
    }
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 1000;
      background: #2c3e50;
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 4px;
      font-size: 20px;
      cursor: pointer;
    }
    .sidebar {
      background: #2c3e50;
      color: white;
      padding: 20px 0;
      width: 220px;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      z-index: 999;
      display: flex;
      flex-direction: column;
    }
    .sidebar h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.2em;
    }
    .sidebar button:not(.admin-toggle-sidebar) {
      display: block;
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 8px;
      background: transparent;
      color: white;
      border: none;
      text-align: left;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.2s;
    }
    .sidebar button:hover,
    .sidebar button.active {
      background: #34495e;
    }
    .admin-toggle-sidebar {
      background: #e74c3c !important;
      color: white !important;
      border: none;
      border-radius: 4px;
      text-align: center;
      font-size: 14px;
      padding: 10px !important;
      cursor: pointer;
      margin-top: auto;
      margin: 0 16px 20px;
      width: calc(100% - 32px) !important;
    }
    .admin-toggle-sidebar:hover {
      background: #c0392b !important;
    }
    .main-content {
      padding: 16px;
    }
    @media (max-width: 767px) {
      .mobile-menu-toggle {
        display: block;
      }
      .main-content {
        padding-top: 60px;
      }
      .sidebar {
        transform: translateX(-100%);
        box-shadow: 4px 0 10px rgba(0,0,0,0.2);
      }
      .sidebar.open {
        transform: translateX(0);
      }
    }
    @media (min-width: 768px) {
      .sidebar {
        transform: none !important;
      }
      .main-content {
        padding: 25px;
        padding-left: 245px;
      }
    }
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.4);
      z-index: 998;
    }
    @media (max-width: 767px) {
      .sidebar-overlay.active {
        display: block;
      }
    }
    .section { display: none; }
    .section.active { display: block; }
    h2.section-title {
      margin-top: 0;
      color: #2c3e50;
      font-size: 1.4em;
    }
    .search-box {
      margin-bottom: 12px;
      width: 100%;
      padding: 8px 12px;
      font-size: 15px;
      border: 1px solid #999;
      border-radius: 4px;
    }
    .table-wrapper {
      overflow-x: auto;
      margin-top: 10px;
    }
    .participants-table-responsive {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 16px;
    }
    .participants-table-responsive th,
    .participants-table-responsive td {
      padding: 10px;
      text-align: center;
      border: 1px solid #ccc;
      vertical-align: middle;
      width: 25%;
    }
    .participants-table-responsive th:first-child,
    .participants-table-responsive td:first-child {
      text-align: left;
      padding-left: 10px;
      padding-right: 10px;
    }
    .participants-table-responsive textarea {
      width: 100%;
      min-height: 28px;
      resize: none;
      overflow: hidden;
      padding: 6px 8px;
      border: 1px solid #999;
      border-radius: 4px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      text-align: left;
      box-sizing: border-box;
    }
    @media (max-width: 767px) {
      .participants-table-responsive {
        font-size: 13px;
      }
      .participants-table-responsive th,
      .participants-table-responsive td {
        padding: 6px 4px;
        font-size: 12px;
      }
      .participants-table-responsive textarea {
        font-size: 13px;
      }
    }
    th {
      background-color: #ecf0f1;
    }
    input[type="number"],
    textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #999;
      border-radius: 4px;
      font-size: 16px;
      font-family: Arial, sans-serif;
    }
    #participantsBody input[type="number"] {
      width: 100%;
      max-width: 60px;
      text-align: center;
      padding: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    @media (max-width: 767px) {
      #participantsBody input[type="number"] {
        max-width: 48px;
        padding: 5px;
        font-size: 12px;
      }
    }
    .task-list {
      list-style: none;
      padding: 0;
    }
    .task-item {
      display: flex;
      align-items: flex-start;
      margin-bottom: 12px;
      padding: 6px 0;
      gap: 10px;
      width: 100%;
    }
    .task-checkbox {
      flex-shrink: 0;
      margin-top: 4px;
      transform: scale(1.3);
      accent-color: #3498db;
    }
    .task-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .task-text-display,
    .task-item textarea {
      width: 100%;
      min-height: 24px;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      font-family: Arial, sans-serif;
      font-size: 14px;
      resize: none;
      overflow: hidden;
    }
    .task-item textarea {
      border: 1px solid #999;
      text-align: left;
    }
    .task-text-display {
      white-space: pre-wrap;
      word-break: break-word;
    }
    .task-assignees {
      font-size: 13px;
      color: #555;
    }
    .task-actions {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }
    .btn {
      padding: 8px 12px;
      margin-top: 8px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn:hover {
      background: #2980b9;
    }
    .btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .btn-sm {
      padding: 6px 10px;
      font-size: 13px;
    }
    .task-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 12px 0;
    }
    .admin-only {
      display: none;
    }
    .admin-visible.admin-only {
      display: flex;
    }
    .no-tasks {
      color: #7f8c8d;
      font-style: italic;
      padding: 12px 0;
    }
    @media (max-width: 767px) {
      .task-controls {
        flex-direction: column;
        gap: 8px;
        align-items: stretch;
      }
    }
    .action-btn {
      padding: 4px 6px;
      font-size: 12px;
      margin-right: 4px;
      min-width: 28px;
    }
    .export-import {
      display: flex;
      gap: 10px;
      margin: 12px 0;
    }
    .task-controls-top-hidden {
      display: none !important;
    }
  .assign-dropdown {
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    font-family: Arial, sans-serif;
    font-size: 13px;
    width: 220px;
    max-height: 300px;
    overflow: hidden;
    z-index: 2000;
  }
  </style>
</head>
<body>
  <button class="mobile-menu-toggle" id="menuToggle">‚ò∞</button>
  <div class="sidebar" id="sidebar">
    <h2>–ù–∞–≤–∏–≥–∞—Ü–∏—è</h2>
    <button data-target="participants" class="active">–£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
    <button data-target="sector-a">–ú–µ–¥–∏–∞</button>
    <button data-target="sector-b">–í–æ–ª–æ–Ω—Ç—ë—Ä—Å–∫–∏–π</button>
    <button data-target="sector-c">–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π</button>
    <button data-target="sector-d">–£—á–µ–±–Ω–æ-—Ç—Ä—É–¥–æ–≤–æ–π</button>
    <button data-target="sector-e">–î–æ—Å—É–≥–æ–≤—ã–π</button>
    <button data-target="sector-f">–í–æ–∂–∞—Ç—Å–∫–∏–π</button>
    <button class="btn admin-toggle-sidebar" id="adminToggleBtnSidebar">
      üîê –í–æ–π—Ç–∏ –≤ —Ä–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    </button>
  </div>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <div class="main-content">
    <div id="participants" class="section active">
      <h2 class="section-title">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h2>
      <div class="export-import admin-only">
        <button class="btn btn-sm admin-only" id="exportBtn">üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
        <button class="btn btn-sm admin-only" id="importBtn">üì• –ò–º–ø–æ—Ä—Ç –∏–∑ Excel</button>
        <input type="file" id="importFile" accept=".csv" style="display: none;" />
      </div>
      <input type="text" class="search-box" id="participantSearch" placeholder="–ü–æ–∏—Å–∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –ø–æ –∏–º–µ–Ω–∏...">
      <div class="table-wrapper">
        <table class="participants-table-responsive">
          <thead>
            <tr>
              <th>–ò–º—è</th>
              <th>–ó–≤—ë–∑–¥—ã ‚≠ê</th>
              <th>–ß–µ—Ä–µ–ø–∫–∏ üíÄ</th>
              <th id="actionsHeader">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody id="participantsBody"></tbody>
        </table>
      </div>
      <button class="btn admin-only" id="addParticipantBtn" onclick="addNewParticipant()">+ –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</button>
    </div>

    <!-- –°–µ–∫—Ç–æ—Ä—ã -->
    <div id="sector-a" class="section">
      <h2 class="section-title">–ü–ª–∞–Ω –¥–µ–ª ‚Äî –ú–µ–¥–∏–∞</h2>
      <div class="task-controls task-controls-top" id="controls-top-a">
        <button class="btn btn-sm admin-only" id="toggleSelect-a">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
        <button class="btn btn-sm admin-only" id="deleteDoneTop-a">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
      </div>
      <ul id="tasks-a" class="task-list">
        <li class="no-tasks">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</li>
      </ul>
      <div class="task-controls">
        <button class="btn btn-sm admin-only" onclick="addTask('a')">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
        <div class="admin-only admin-visible" style="display:flex;gap:8px;">
          <button class="btn btn-sm admin-only" id="toggleSelect-a-bottom">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
          <button class="btn btn-sm admin-only" id="deleteDoneBottom-a">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
        </div>
      </div>
    </div>
    <div id="sector-b" class="section">
      <h2 class="section-title">–ü–ª–∞–Ω –¥–µ–ª ‚Äî –í–æ–ª–æ–Ω—Ç—ë—Ä—Å–∫–∏–π</h2>
      <div class="task-controls task-controls-top" id="controls-top-b">
        <button class="btn btn-sm admin-only" id="toggleSelect-b">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
        <button class="btn btn-sm admin-only" id="deleteDoneTop-b">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
      </div>
      <ul id="tasks-b" class="task-list">
        <li class="no-tasks">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</li>
      </ul>
      <div class="task-controls">
        <button class="btn btn-sm admin-only" onclick="addTask('b')">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
        <div class="admin-only admin-visible" style="display:flex;gap:8px;">
          <button class="btn btn-sm admin-only" id="toggleSelect-b-bottom">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
          <button class="btn btn-sm admin-only" id="deleteDoneBottom-b">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
        </div>
      </div>
    </div>
    <div id="sector-c" class="section">
      <h2 class="section-title">–ü–ª–∞–Ω –¥–µ–ª ‚Äî –°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π</h2>
      <div class="task-controls task-controls-top" id="controls-top-c">
        <button class="btn btn-sm admin-only" id="toggleSelect-c">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
        <button class="btn btn-sm admin-only" id="deleteDoneTop-c">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
      </div>
      <ul id="tasks-c" class="task-list">
        <li class="no-tasks">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</li>
      </ul>
      <div class="task-controls">
        <button class="btn btn-sm admin-only" onclick="addTask('c')">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
        <div class="admin-only admin-visible" style="display:flex;gap:8px;">
          <button class="btn btn-sm admin-only" id="toggleSelect-c-bottom">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
          <button class="btn btn-sm admin-only" id="deleteDoneBottom-c">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
        </div>
      </div>
    </div>
    <div id="sector-d" class="section">
      <h2 class="section-title">–ü–ª–∞–Ω –¥–µ–ª ‚Äî –£—á–µ–±–Ω–æ-—Ç—Ä—É–¥–æ–≤–æ–π</h2>
      <div class="task-controls task-controls-top" id="controls-top-d">
        <button class="btn btn-sm admin-only" id="toggleSelect-d">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
        <button class="btn btn-sm admin-only" id="deleteDoneTop-d">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
      </div>
      <ul id="tasks-d" class="task-list">
        <li class="no-tasks">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</li>
      </ul>
      <div class="task-controls">
        <button class="btn btn-sm admin-only" onclick="addTask('d')">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
        <div class="admin-only admin-visible" style="display:flex;gap:8px;">
          <button class="btn btn-sm admin-only" id="toggleSelect-d-bottom">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
          <button class="btn btn-sm admin-only" id="deleteDoneBottom-d">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
        </div>
      </div>
    </div>
    <div id="sector-e" class="section">
      <h2 class="section-title">–ü–ª–∞–Ω –¥–µ–ª ‚Äî –î–æ—Å—É–≥–æ–≤—ã–π</h2>
      <div class="task-controls task-controls-top" id="controls-top-e">
        <button class="btn btn-sm admin-only" id="toggleSelect-e">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
        <button class="btn btn-sm admin-only" id="deleteDoneTop-e">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
      </div>
      <ul id="tasks-e" class="task-list">
        <li class="no-tasks">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</li>
      </ul>
      <div class="task-controls">
        <button class="btn btn-sm admin-only" onclick="addTask('e')">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
        <div class="admin-only admin-visible" style="display:flex;gap:8px;">
          <button class="btn btn-sm admin-only" id="toggleSelect-e-bottom">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
          <button class="btn btn-sm admin-only" id="deleteDoneBottom-e">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
        </div>
      </div>
    </div>
    <div id="sector-f" class="section">
      <h2 class="section-title">–ü–ª–∞–Ω –¥–µ–ª ‚Äî –í–æ–∂–∞—Ç—Å–∫–∏–π</h2>
      <div class="task-controls task-controls-top" id="controls-top-f">
        <button class="btn btn-sm admin-only" id="toggleSelect-f">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
        <button class="btn btn-sm admin-only" id="deleteDoneTop-f">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
      </div>
      <ul id="tasks-f" class="task-list">
        <li class="no-tasks">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</li>
      </ul>
      <div class="task-controls">
        <button class="btn btn-sm admin-only" onclick="addTask('f')">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
        <div class="admin-only admin-visible" style="display:flex;gap:8px;">
          <button class="btn btn-sm admin-only" id="toggleSelect-f-bottom">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
          <button class="btn btn-sm admin-only" id="deleteDoneBottom-f">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDaxVRaPKFca3aiplOA-UwbUOwrrLlCr_A",
      authDomain: "website-dsho-legend.firebaseapp.com",
      databaseURL: "https://website-dsho-legend-default-rtdb.firebaseio.com",
      projectId: "website-dsho-legend",
      storageBucket: "website-dsho-legend.firebasestorage.app",
      messagingSenderId: "963395738991",
      appId: "1:963395738991:web:4f5ecd4277205a71389c9a",
      measurementId: "G-N8BVW01MVS"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
    const db = firebase.database();
    const ADMIN_PASSWORD = "–ù–∞ –≥–æ—Ä—à–∫–µ —Å–∏–¥–µ–ª –∫–æ—Ä–æ–ª—å";
    let isAdmin = false;
    const ACTIVE_TAB_KEY = 'activeTab';
    let currentTab = localStorage.getItem(ACTIVE_TAB_KEY) || 'participants';
    let participantsList = [];
    let participantsLoaded = false;
    const sectorListeners = {};

    function updateAdminUI() {
      document.querySelectorAll('.admin-only').forEach(el => {
        el.classList.toggle('admin-visible', isAdmin);
      });
      const actionsHeader = document.getElementById('actionsHeader');
      if (actionsHeader) actionsHeader.style.display = isAdmin ? '' : 'none';
    }

    function exportToCSV() {
      if (!isAdmin) return;
      let csv = '–ò–º—è,–ó–≤—ë–∑–¥—ã,–ß–µ—Ä–µ–ø–∫–∏\n';
      participantsList.forEach(p => {
        csv += `"${p.name.replace(/"/g, '""')}",${p.stars},${p.skulls}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = '—É—á–∞—Å—Ç–Ω–∏–∫–∏_–ª–∏–¥–µ—Ä–±–æ—Ä–¥.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    function importFromCSV(file) {
      if (!isAdmin) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        const lines = text.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
          alert('–§–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.');
          return;
        }
        const header = lines[0].split(',').map(h => h.trim());
        if (header[0] !== '–ò–º—è' || header[1] !== '–ó–≤—ë–∑–¥—ã' || header[2] !== '–ß–µ—Ä–µ–ø–∫–∏') {
          alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –û–∂–∏–¥–∞—é—Ç—Å—è —Å—Ç–æ–ª–±—Ü—ã: –ò–º—è, –ó–≤—ë–∑–¥—ã, –ß–µ—Ä–µ–ø–∫–∏');
          return;
        }
        if (!confirm('‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –ò–º–ø–æ—Ä—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;
        const batch = db.ref().child('participants');
        batch.remove();
        setTimeout(() => {
          lines.slice(1).forEach(line => {
            const [name, stars, skulls] = line.split(',').map(s => s.trim().replace(/^"(.*)"$/, '$1'));
            if (name) {
              batch.push({
                name: name,
                stars: parseInt(stars) || 0,
                skulls: parseInt(skulls) || 0
              });
            }
          });
          alert('‚úÖ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!');
        }, 500);
      };
      reader.readAsText(file, 'utf-8');
    }

    function enterAdminMode() {
      const pass = prompt("üîí –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:");
      if (pass === ADMIN_PASSWORD) {
        isAdmin = true;
        document.querySelectorAll('.admin-toggle-sidebar').forEach(el => {
          el.textContent = "üîì –†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–∞–∫—Ç–∏–≤–µ–Ω)";
        });
        updateAdminUI();
        alert("‚úÖ –í—ã –≤–æ—à–ª–∏ –≤ —Ä–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.");
        initParticipantsTable();
        reinitAllTasks();
      } else if (pass !== null) {
        alert("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
      }
    }

    function exitAdminMode() {
      isAdmin = false;
      document.querySelectorAll('.admin-toggle-sidebar').forEach(el => {
        el.textContent = "üîê –í–æ–π—Ç–∏ –≤ —Ä–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞";
      });
      updateAdminUI();
      alert("‚úÖ –†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ—Ç–∫–ª—é—á—ë–Ω.");
      initParticipantsTable();
      reinitAllTasks();
    }

    function updateTaskControlsVisibility(sector) {
      const list = document.getElementById(`tasks-${sector}`);
      const topControls = document.getElementById(`controls-top-${sector}`);
      if (!list || !topControls) return;
      const noTasks = list.querySelector('.no-tasks');
      const hasTasks = list.children.length > (noTasks ? 1 : 0);
      if (hasTasks) {
        const listHeight = list.getBoundingClientRect().height;
        const viewportHeight = window.innerHeight;
        const shouldShow = listHeight > viewportHeight * 0.8;
        topControls.classList.toggle('task-controls-top-hidden', !shouldShow);
      } else {
        topControls.classList.add('task-controls-top-hidden');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const menuToggle = document.getElementById('menuToggle');
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      const adminBtn = document.getElementById('adminToggleBtnSidebar');
      const exportBtn = document.getElementById('exportBtn');
      const importBtn = document.getElementById('importBtn');
      const importFile = document.getElementById('importFile');

      if (adminBtn) {
        adminBtn.onclick = () => isAdmin ? exitAdminMode() : enterAdminMode();
      }
      if (exportBtn) {
        exportBtn.onclick = exportToCSV;
      }
      if (importBtn) {
        importBtn.onclick = () => importFile.click();
      }
      if (importFile) {
        importFile.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            importFromCSV(file);
            importFile.value = '';
          }
        };
      }

      if (menuToggle) {
        menuToggle.addEventListener('click', () => {
          sidebar.classList.add('open');
          overlay.classList.add('active');
        });
      }

      const closeSidebar = () => {
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
      };
      overlay.addEventListener('click', closeSidebar);

      document.querySelectorAll('.sidebar button:not(.admin-toggle-sidebar)').forEach(btn => {
        btn.addEventListener('click', () => {
          if (window.innerWidth <= 767) {
            closeSidebar();
          }
        });
      });

      const searchInput = document.getElementById('participantSearch');
      if (searchInput) {
        searchInput.addEventListener('input', () => {
          const query = searchInput.value.trim().toLowerCase();
          const rows = document.querySelectorAll('#participantsBody tr');
          rows.forEach(row => {
            const name = row.querySelector('textarea')?.value || '';
            row.style.display = name.toLowerCase().includes(query) ? '' : 'none';
          });
        });
      }

      updateAdminUI();
    });

    function unsubscribeFromTasks(sector) {
      if (sectorListeners[sector]) {
        const { ref, handlers } = sectorListeners[sector];
        ref.off('child_added', handlers.added);
        ref.off('child_changed', handlers.changed);
        ref.off('child_removed', handlers.removed);
        delete sectorListeners[sector];
      }
    }

    function reinitAllTasks() {
      if (currentTab.startsWith('sector-')) {
        const sector = currentTab.split('-')[1];
        unsubscribeFromTasks(sector);
        document.getElementById(`tasks-${sector}`).innerHTML = '<li class="no-tasks">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</li>';
        initTasks(sector);
      }
    }

    function loadParticipants() {
      return new Promise((resolve) => {
        db.ref('participants').once('value', (snapshot) => {
          participantsList = [];
          const data = snapshot.val() || {};
          Object.entries(data).forEach(([key, p]) => {
            participantsList.push({ key, name: p.name || '', stars: p.stars || 0, skulls: p.skulls || 0 });
          });
          participantsLoaded = true;
          renderParticipantsTable();
          resolve();
        });
      });
    }

    function renderParticipantsTable() {
      const tbody = document.getElementById('participantsBody');
      tbody.innerHTML = '';
      const sorted = [...participantsList].sort((a, b) => (b.stars - b.skulls * 10) - (a.stars - a.skulls * 10));
      sorted.forEach(p => {
        const row = document.createElement('tr');
        row.dataset.key = p.key;

        const nameCell = document.createElement('td');
        const nameTextarea = document.createElement('textarea');
        nameTextarea.value = p.name;
        nameTextarea.rows = 1;
        nameTextarea.style.resize = 'none';
        nameTextarea.style.overflow = 'hidden';
        nameTextarea.style.fontFamily = 'Arial, sans-serif';
        nameTextarea.style.fontSize = '14px';
        nameTextarea.style.padding = '6px 8px';
        nameTextarea.style.border = '1px solid #999';
        nameTextarea.style.borderRadius = '4px';
        nameTextarea.style.textAlign = 'left';
        nameTextarea.style.minHeight = '28px';
        nameTextarea.style.width = '100%';
        nameTextarea.disabled = !isAdmin;

        const autoSizeName = () => {
          nameTextarea.style.height = 'auto';
          nameTextarea.style.height = Math.max(28, nameTextarea.scrollHeight) + 'px';
        };
        autoSizeName();

        if (isAdmin) {
          nameTextarea.addEventListener('input', autoSizeName);
          nameTextarea.addEventListener('blur', () => {
            db.ref(`participants/${p.key}/name`).set(nameTextarea.value.trim() || '–ë–µ–∑ –∏–º–µ–Ω–∏');
          });
        }
        nameCell.appendChild(nameTextarea);

        const starsCell = document.createElement('td');
        const starsInput = document.createElement('input');
        starsInput.type = 'number';
        starsInput.min = '0';
        starsInput.value = p.stars;
        starsInput.disabled = !isAdmin;
        starsInput.style.width = '100%';
        if (isAdmin) {
          starsInput.addEventListener('blur', () => {
            const val = Math.max(0, parseInt(starsInput.value) || 0);
            db.ref(`participants/${p.key}/stars`).set(val);
            starsInput.value = val;
          });
          starsInput.addEventListener('focus', (e) => {
            e.target.dataset.scrollY = window.scrollY;
          });
          starsInput.addEventListener('blur', (e) => {
            setTimeout(() => {
              window.scrollTo(0, e.target.dataset.scrollY);
            }, 10);
          });
          starsInput.addEventListener('dblclick', () => {
            const newVal = p.stars + 1;
            db.ref(`participants/${p.key}/stars`).set(newVal);
          });
        }
        starsCell.appendChild(starsInput);

        const skullsCell = document.createElement('td');
        const skullsInput = document.createElement('input');
        skullsInput.type = 'number';
        skullsInput.min = '0';
        skullsInput.value = p.skulls;
        skullsInput.disabled = !isAdmin;
        skullsInput.style.width = '100%';
        if (isAdmin) {
          skullsInput.addEventListener('blur', () => {
            const val = Math.max(0, parseInt(skullsInput.value) || 0);
            db.ref(`participants/${p.key}/skulls`).set(val);
            skullsInput.value = val;
          });
          skullsInput.addEventListener('focus', (e) => {
            e.target.dataset.scrollY = window.scrollY;
          });
          skullsInput.addEventListener('blur', (e) => {
            setTimeout(() => {
              window.scrollTo(0, e.target.dataset.scrollY);
            }, 10);
          });
        }
        skullsCell.appendChild(skullsInput);

        const actionsCell = document.createElement('td');
        if (isAdmin) {
          const chocolateBtn = document.createElement('button');
          chocolateBtn.textContent = 'üç´';
          chocolateBtn.title = '–ü–æ—Ç—Ä–∞—Ç–∏—Ç—å 10 –∑–≤—ë–∑–¥';
          chocolateBtn.className = 'btn action-btn';
          chocolateBtn.disabled = p.stars < 10;
          chocolateBtn.onclick = () => p.stars >= 10 ? db.ref(`participants/${p.key}/stars`).set(p.stars - 10) : alert('–ù—É–∂–Ω–æ 10+ –∑–≤—ë–∑–¥!');
          actionsCell.appendChild(chocolateBtn);

          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'üóëÔ∏è';
          deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å';
          deleteBtn.className = 'btn action-btn';
          deleteBtn.onclick = () => confirm(`–£–¥–∞–ª–∏—Ç—å "${p.name}"?`) && db.ref(`participants/${p.key}`).remove();
          actionsCell.appendChild(deleteBtn);
        }
        actionsCell.style.display = isAdmin ? 'flex' : 'none';
        actionsCell.style.justifyContent = 'center';
        actionsCell.style.gap = '4px';

        row.append(nameCell, starsCell, skullsCell, actionsCell);
        tbody.appendChild(row);
      });

      const searchInput = document.getElementById('participantSearch');
      if (searchInput) {
        const event = new Event('input');
        searchInput.dispatchEvent(event);
      }
    }

    function initParticipantsTable() {
      db.ref('participants').on('value', (snapshot) => {
        participantsList = [];
        const data = snapshot.val() || {};
        Object.entries(data).forEach(([key, p]) => {
          participantsList.push({ key, name: p.name || '', stars: p.stars || 0, skulls: p.skulls || 0 });
        });
        renderParticipantsTable();
      });
    }

    async function initTasks(sector) {
      if (!participantsLoaded) await loadParticipants();

      const list = document.getElementById(`tasks-${sector}`);
      const topControls = document.getElementById(`controls-top-${sector}`);
      const bottomControls = Array.from(document.querySelectorAll(`#sector-${sector} .task-controls`)).pop();

      list.innerHTML = '<li class="no-tasks">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</li>';
      if (topControls) topControls.classList.add('task-controls-top-hidden');

      // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫ –∫–Ω–æ–ø–∫–∞–º —Å–≤–µ—Ä—Ö—É
      const toggleTop = document.getElementById(`toggleSelect-${sector}`);
      const deleteTop = document.getElementById(`deleteDoneTop-${sector}`);

      if (toggleTop) {
        toggleTop.onclick = () => toggleSelectAll(sector);
      }

      if (deleteTop) {
        deleteTop.onclick = () => {
          if (!isAdmin || !confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏?')) return;
          db.ref(`tasks/${sector}`).once('value', (snapshot) => {
            const tasks = snapshot.val() || {};
            Object.entries(tasks).forEach(([key, task]) => {
              if (task.done) db.ref(`tasks/${sector}/${key}`).remove();
            });
          });
        };
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∏–∂–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
      if (bottomControls) {
        bottomControls.innerHTML = `
          <button class="btn btn-sm admin-only" onclick="addTask('${sector}')">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
          <div class="admin-only admin-visible" style="display:flex;gap:8px;">
            <button class="btn btn-sm admin-only" id="toggleSelect-${sector}-bottom">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
            <button class="btn btn-sm admin-only" id="deleteDoneBottom-${sector}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
          </div>
        `;
        const toggleBottom = document.getElementById(`toggleSelect-${sector}-bottom`);
        const deleteBottom = document.getElementById(`deleteDoneBottom-${sector}`);
        if (toggleBottom) toggleBottom.onclick = () => toggleSelectAll(sector);
        if (deleteBottom) {
          deleteBottom.onclick = () => {
            if (!isAdmin || !confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏?')) return;
            db.ref(`tasks/${sector}`).once('value', (snapshot) => {
              const tasks = snapshot.val() || {};
              Object.entries(tasks).forEach(([key, task]) => {
                if (task.done) db.ref(`tasks/${sector}/${key}`).remove();
              });
            });
          };
        }
      }

      updateAdminUI();

      const ref = db.ref(`tasks/${sector}`);
      const handlers = {
        added: (snapshot) => {
          if (list.querySelector('.no-tasks')) {
            list.innerHTML = '';
          }
          renderTask(sector, snapshot.key, snapshot.val());
          setTimeout(() => updateTaskControlsVisibility(sector), 100);
        },
        changed: (snapshot) => {
          const li = list.querySelector(`li[data-key="${snapshot.key}"]`);
          if (li) {
            updateTask(sector, snapshot.key, snapshot.val(), li);
          } else {
            if (list.querySelector('.no-tasks')) list.innerHTML = '';
            renderTask(sector, snapshot.key, snapshot.val());
          }
          setTimeout(() => updateTaskControlsVisibility(sector), 100);
        },
        removed: (snapshot) => {
          const li = list.querySelector(`li[data-key="${snapshot.key}"]`);
          if (li) li.remove();
          if (list.children.length === 0) {
            list.innerHTML = '<li class="no-tasks">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</li>';
          }
          setTimeout(() => updateTaskControlsVisibility(sector), 100);
        }
      };

      ref.on('child_added', handlers.added);
      ref.on('child_changed', handlers.changed);
      ref.on('child_removed', handlers.removed);
      sectorListeners[sector] = { ref, handlers };
    }

function renderTask(sector, taskKey, data) {
  const list = document.getElementById(`tasks-${sector}`);
  if (list.querySelector('.no-tasks')) {
    list.innerHTML = '';
  }

  const li = document.createElement('li');
  li.className = 'task-item';
  li.dataset.key = taskKey;

  const checkbox = document.createElement('input');
  checkbox.type = 'checkbox';
  checkbox.checked = data.done || false;
  checkbox.disabled = !isAdmin;
  checkbox.className = 'task-checkbox';
  if (isAdmin) {
    checkbox.addEventListener('change', () => {
      db.ref(`tasks/${sector}/${taskKey}/done`).set(checkbox.checked);
    });
  }

  const contentDiv = document.createElement('div');
  contentDiv.className = 'task-content';

  if (isAdmin) {
    const textInput = document.createElement('textarea');
    textInput.value = data.text || '';
    textInput.placeholder = '–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏';
    textInput.style.fontFamily = 'Arial, sans-serif';
    textInput.style.fontSize = '14px';
    const autoSize = () => {
      textInput.style.height = 'auto';
      textInput.style.height = Math.max(24, textInput.scrollHeight) + 'px';
    };
    autoSize();
    textInput.addEventListener('input', autoSize);
    textInput.addEventListener('blur', () => {
      db.ref(`tasks/${sector}/${taskKey}/text`).set(textInput.value);
    });
    contentDiv.appendChild(textInput);
  } else {
    const textDisplay = document.createElement('div');
    textDisplay.className = 'task-text-display';
    textDisplay.textContent = data.text || '';
    contentDiv.appendChild(textDisplay);
  }

  if (data.assignees?.length > 0) {
    const assigneesDiv = document.createElement('div');
    assigneesDiv.className = 'task-assignees';
    const names = data.assignees.map(k => participantsList.find(p => p.key === k)?.name || '???').join(', ');
    assigneesDiv.textContent = `–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏: ${names}`;
    contentDiv.appendChild(assigneesDiv);
  }

  if (isAdmin) {
    const assignBtn = document.createElement('button');
    assignBtn.textContent = 'üë• –ù–∞–∑–Ω–∞—á–∏—Ç—å';
    assignBtn.className = 'btn btn-sm admin-only admin-visible';
    assignBtn.onclick = (e) => {
      e.stopPropagation();
      document.querySelectorAll('.assign-dropdown').forEach(el => el.remove());

      const dropdown = document.createElement('div');
      dropdown.className = 'assign-dropdown';

      // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º —Ä—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–æ–π
      const rect = assignBtn.getBoundingClientRect();
      dropdown.style.position = 'absolute';
      dropdown.style.left = rect.left + 'px';
      dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
      dropdown.style.zIndex = '2000';
      dropdown.style.background = 'white';
      dropdown.style.border = '1px solid #ccc';
      dropdown.style.borderRadius = '4px';
      dropdown.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
      dropdown.style.fontFamily = 'Arial, sans-serif';
      dropdown.style.fontSize = '13px';
      dropdown.style.width = '220px';
      dropdown.style.maxHeight = '300px';
      dropdown.style.overflow = 'hidden'; // –≤–∞–∂–Ω–æ: overflow –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º –±–ª–æ–∫–µ ‚Äî hidden

      // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
      const scrollContainer = document.createElement('div');
      scrollContainer.style.maxHeight = '220px';
      scrollContainer.style.overflowY = 'auto';
      scrollContainer.style.padding = '8px';

      const current = data.assignees || [];
      participantsList.forEach(p => {
        const label = document.createElement('label');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = p.key;
        cb.checked = current.includes(p.key);
        label.style.display = 'block';
        label.style.margin = '4px 0';
        label.style.cursor = 'pointer';
        label.append(cb, document.createTextNode(` ${p.name}`));
        scrollContainer.appendChild(label);
      });

      // –ö–Ω–æ–ø–∫–∞ "–ì–æ—Ç–æ–≤–æ" ‚Äî –≤–Ω–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
      const done = document.createElement('button');
      done.textContent = '–ì–æ—Ç–æ–≤–æ';
      done.className = 'btn';
      done.style.width = 'calc(100% - 16px)';
      done.style.margin = '0 8px 8px';
      done.style.fontSize = '13px';
      done.onclick = () => {
        const sel = Array.from(dropdown.querySelectorAll('input:checked')).map(cb => cb.value);
        db.ref(`tasks/${sector}/${taskKey}/assignees`).set(sel.length ? sel : null);
        dropdown.remove();
      };

      dropdown.appendChild(scrollContainer);
      dropdown.appendChild(done);
      document.body.appendChild(dropdown);

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ
      const close = (e) => {
        if (!dropdown.contains(e.target) && e.target !== assignBtn) {
          dropdown.remove();
          document.removeEventListener('click', close);
        }
      };
      document.addEventListener('click', close);
    };
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'task-actions admin-only admin-visible';
    actionsDiv.appendChild(assignBtn);
    contentDiv.appendChild(actionsDiv);
  }

  li.appendChild(checkbox);
  li.appendChild(contentDiv);
  list.appendChild(li);
}
    function updateTask(sector, taskKey, data, li) {
      const checkbox = li.querySelector('.task-checkbox');
      if (checkbox) {
        checkbox.checked = data.done || false;
        checkbox.disabled = !isAdmin;
      }

      const textDisplay = li.querySelector('.task-text-display');
      const textArea = li.querySelector('textarea');
      if (isAdmin && textArea) {
        if (document.activeElement !== textArea) {
          textArea.value = data.text || '';
          textArea.style.height = 'auto';
          textArea.style.height = Math.max(24, textArea.scrollHeight) + 'px';
        }
      } else if (!isAdmin && textDisplay) {
        textDisplay.textContent = data.text || '';
      }

      const assigneesDiv = li.querySelector('.task-assignees');
      if (assigneesDiv) {
        if (data.assignees?.length > 0) {
          const names = data.assignees.map(k => participantsList.find(p => p.key === k)?.name || '???').join(', ');
          assigneesDiv.textContent = `–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏: ${names}`;
        } else {
          assigneesDiv.remove();
        }
      } else if (data.assignees?.length > 0 && !assigneesDiv) {
        const contentDiv = li.querySelector('.task-content');
        const newAssignees = document.createElement('div');
        newAssignees.className = 'task-assignees';
        const names = data.assignees.map(k => participantsList.find(p => p.key === k)?.name || '???').join(', ');
        newAssignees.textContent = `–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏: ${names}`;
        contentDiv.appendChild(newAssignees);
      }
    }

    function toggleSelectAll(sector) {
      if (!isAdmin) return;
      const list = document.getElementById(`tasks-${sector}`);
      const checkboxes = list.querySelectorAll('.task-checkbox');
      if (checkboxes.length === 0) return;
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      const newState = !allChecked;
      checkboxes.forEach(cb => {
        cb.checked = newState;
        db.ref(`tasks/${sector}/${cb.closest('li').dataset.key}/done`).set(newState);
      });

      const buttons = document.querySelectorAll(
        `#toggleSelect-${sector}, #toggleSelect-${sector}-bottom`
      );
      buttons.forEach(btn => {
        btn.textContent = newState ? '–°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ' : '–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë';
      });
    }

    function switchTab(target) {
      document.querySelectorAll('.sidebar button:not(.admin-toggle-sidebar)').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      const btn = document.querySelector(`.sidebar button[data-target="${target}"]`);
      btn?.classList.add('active');
      document.getElementById(target)?.classList.add('active');
      localStorage.setItem(ACTIVE_TAB_KEY, target);
      currentTab = target;
      if (target.startsWith('sector-')) {
        const sector = target.split('-')[1];
        unsubscribeFromTasks(sector);
        document.getElementById(`tasks-${sector}`).innerHTML = '<li class="no-tasks">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</li>';
        initTasks(sector);
      }
    }

    function scrollToBottom() {
      setTimeout(() => {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      }, 100);
    }

    window.addNewParticipant = () => {
      if (!isAdmin) return enterAdminMode();
      const name = prompt("–ò–º—è:", "–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫");
      if (name?.trim()) {
        db.ref('participants').push({ name: name.trim(), stars: 0, skulls: 0 });
        scrollToBottom();
      }
    };

    window.addTask = (sector) => {
      if (!isAdmin) return enterAdminMode();
      const text = prompt("–ó–∞–¥–∞—á–∞:", "–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞");
      if (text?.trim()) {
        db.ref(`tasks/${sector}`).push({ text: text.trim(), done: false, assignees: null });
        scrollToBottom();
      }
    };

    document.addEventListener('DOMContentLoaded', async () => {
      await loadParticipants();
      document.querySelectorAll('.sidebar button:not(.admin-toggle-sidebar)').forEach(btn => {
        if (!btn.dataset.clickBound) {
          btn.addEventListener('click', () => switchTab(btn.dataset.target));
          btn.dataset.clickBound = 'true';
        }
      });
      switchTab(currentTab);
      initParticipantsTable();
    });
  </script>
</body>
</html>
