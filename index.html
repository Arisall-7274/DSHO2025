<!DOCTYPE html>
<html lang="ru">
<head>
<link rel="icon" type="image/png" href="favicon.png">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ—Å–∫–∞</title>
<style>
* { 
  box-sizing: border-box; 
  margin: 0;
  padding: 0;
}
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f9f9f9;
  min-height: 100vh;
  overflow-x: hidden;
  color: #333;
  line-height: 1.5;
}
.mobile-menu-toggle {
  display: none;
  position: fixed;
  top: 16px;
  left: 16px;
  z-index: 1000;
  background: #2c3e50;
  color: white;
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 4px;
  font-size: 20px;
  cursor: pointer;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.sidebar {
  background: #2c3e50;
  color: white;
  padding: 20px 0;
  width: 220px;
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  z-index: 999;
  display: flex;
  flex-direction: column;
  box-shadow: 2px 0 10px rgba(0,0,0,0.1);
}
.sidebar h2 {
  text-align: center;
  margin-bottom: 20px;
  font-size: 1.3em;
  padding: 0 16px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.sidebar button:not(.admin-toggle-sidebar) {
  display: block;
  width: 100%;
  padding: 14px 18px;
  margin-bottom: 6px;
  background: transparent;
  color: white;
  border: none;
  text-align: left;
  cursor: pointer;
  font-size: 1.05em;
  transition: background 0.2s;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-weight: 500;
}
.sidebar button:hover,
.sidebar button.active {
  background: #34495e;
}
.admin-toggle-sidebar {
  background: #e74c3c !important;
  color: white !important;
  border: none;
  border-radius: 6px;
  text-align: center;
  font-size: 15px;
  padding: 14px !important;
  cursor: pointer;
  margin-top: auto;
  margin: 0 20px 25px;
  width: calc(100% - 40px) !important;
  font-weight: bold;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.admin-toggle-sidebar:hover {
  background: #c0392b !important;
  transform: translateY(-1px);
}
.main-content {
  padding: 20px 16px;
}
@media (max-width: 767px) {
  .mobile-menu-toggle {
    display: block;
  }
  .main-content {
    padding-top: 70px;
  }
  .sidebar {
    transform: translateX(-100%);
    box-shadow: 4px 0 15px rgba(0,0,0,0.25);
  }
  .sidebar.open {
    transform: translateX(0);
  }
}
@media (min-width: 768px) {
  .sidebar {
    transform: none !important;
  }
  .main-content {
    padding: 30px;
    padding-left: 250px;
  }
}
.sidebar-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.5);
  z-index: 998;
}
@media (max-width: 767px) {
  .sidebar-overlay.active {
    display: block;
  }
}
.section { 
  display: none; 
}
.section.active { 
  display: block; 
}
h2.section-title {
  margin-top: 0;
  color: #2c3e50;
  font-size: 1.8em;
  margin-bottom: 20px;
  font-weight: 600;
  padding-bottom: 8px;
  border-bottom: 2px solid #3498db;
}
.search-container {
  margin-bottom: 20px;
  max-width: 450px;
}
.search-container input {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #3498db;
  border-radius: 8px;
  font-size: 16px;
  font-family: inherit;
  transition: all 0.3s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.search-container input:focus {
  outline: none;
  border-color: #2980b9;
  box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
}
.table-wrapper {
  overflow-x: auto;
  margin-top: 15px;
  background: white;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  border: 1px solid #e0e6ed;
}
/* –¢–∞–±–ª–∏—Ü–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ - —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å */
.participants-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 650px;
  font-size: 16px;
  background: white;
}
.participants-table th,
.participants-table td {
  padding: 14px 12px;
  text-align: center;
  border: 1px solid #e0e6ed;
  vertical-align: middle;
  font-weight: normal;
}
.participants-table th {
  background-color: #3498db !important;
  color: white !important;
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 10;
  font-size: 17px;
}
.participants-table tbody tr {
  transition: background-color 0.2s;
}
.participants-table tbody tr:hover {
  background-color: #f8fbff;
}
.participants-table tbody tr:nth-child(even) {
  background-color: #fafcff;
}
/* –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å –§–ò–û - –∫–ª—é—á–µ–≤—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
.participants-table td:first-child,
.participants-table th:first-child {
  min-width: 220px;
  white-space: normal !important;
  word-wrap: break-word !important;
  word-break: break-word !important;
  hyphens: auto !important;
  text-align: left !important;
  padding-left: 16px !important;
  font-weight: 600;
  color: #2c3e50;
  font-size: 16px;
  line-height: 1.4;
}
/* –ó–≤—ë–∑–¥—ã –∏ —á–µ—Ä–µ–ø–∫–∏ */
.participants-table input[type="number"] {
  width: 70px;
  padding: 8px 6px;
  text-align: center;
  border: 2px solid #bdc3c7;
  border-radius: 6px;
  font-size: 17px;
  font-weight: bold;
  background-color: white;
  transition: all 0.2s;
  color: #2c3e50;
}
.participants-table input[type="number"]:focus {
  outline: none;
  border-color: #3498db;
  box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
}
.participants-table input[type="number"]:disabled {
  background-color: #f8f9fa;
  color: #7f8c8d;
  border-color: #dce4ec;
  cursor: not-allowed;
}
/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
.action-btn {
  padding: 8px 14px;
  margin: 3px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 18px;
  font-weight: bold;
  transition: all 0.2s;
  min-width: 44px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.15);
}
.star-btn {
  background: #f39c12;
  color: white;
}
.star-btn:hover {
  background: #e67e22;
  transform: scale(1.08);
}
.delete-btn {
  background: #e74c3c;
  color: white;
}
.delete-btn:hover {
  background: #c0392b;
  transform: scale(1.08);
}
.admin-column {
  display: none;
}
.admin-visible .admin-column {
  display: table-cell;
}
/* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–¥–∞—á */
.task-list {
  list-style: none;
  padding: 0;
  margin-top: 15px;
}
.task-item {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  margin-bottom: 16px;
  padding: 16px;
  background: white;
  border-radius: 8px;
  border-left: 4px solid #3498db;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  gap: 10px;
  position: relative;
}
@media (min-width: 768px) {
  .task-item {
    flex-direction: row;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
  }
}
.task-item input[type="checkbox"] {
  margin-right: 0;
  transform: scale(1.4);
  cursor: pointer;
  accent-color: #3498db;
}
.task-item textarea {
  width: 100%;
  min-height: 40px;
  resize: vertical;
  padding: 10px 14px;
  border: 2px solid #bdc3c7;
  border-radius: 6px;
  font-family: inherit;
  font-size: 16px;
  line-height: 1.5;
  transition: border-color 0.2s;
  overflow-y: auto;
  background: white;
  color: #2c3e50;
}
.task-item textarea:focus {
  outline: none;
  border-color: #3498db;
  box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}
.task-assignees {
  font-size: 15px;
  color: #7f8c8d;
  width: 100%;
  margin-left: 0 !important;
  padding: 6px 10px;
  background: #f8f9fa;
  border-radius: 6px;
  text-align: left;
  font-style: italic;
}
@media (min-width: 768px) {
  .task-assignees {
    margin-left: 32px !important;
    width: auto;
  }
}
.btn {
  padding: 12px 20px;
  margin-top: 20px;
  background: #3498db;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 17px;
  font-weight: 600;
  min-height: 50px;
  min-width: 140px;
  transition: all 0.25s;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}
.btn:hover {
  background: #2980b9;
  transform: translateY(-2px);
  box-shadow: 0 5px 10px rgba(0,0,0,0.2);
}
.btn:active {
  transform: translateY(0);
}
.btn-add {
  background: #27ae60;
}
.btn-add:hover {
  background: #229954;
}
.btn-delete {
  background: #e74c3c;
  margin-left: 12px;
}
.btn-delete:hover {
  background: #c0392b;
}
.btn-sm {
  padding: 8px 14px;
  font-size: 15px;
  min-height: auto;
}
.export-import {
  display: flex;
  gap: 12px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}
.task-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 20px 0;
  flex-wrap: wrap;
  gap: 12px;
}
@media (max-width: 767px) {
  .task-controls {
    flex-direction: column;
    align-items: stretch;
  }
  .btn {
    width: 100%;
    margin-top: 12px;
  }
  .btn-delete {
    margin-left: 0;
    margin-top: 8px;
  }
  .export-import {
    flex-direction: column;
  }
  .export-import .btn {
    width: 100%;
    margin-top: 0;
  }
}
/* –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö - –ö–õ–Æ–ß–ï–í–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø */
@media (max-width: 767px) {
  body {
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
    text-size-adjust: 100%;
  }
  .participants-table {
    font-size: 15px;
    min-width: 100% !important;
  }
  .participants-table th,
  .participants-table td {
    padding: 12px 10px !important;
    font-size: 15px !important;
  }
  .participants-table td:first-child,
  .participants-table th:first-child {
    min-width: 180px !important;
    font-size: 16px !important;
    padding: 12px 14px !important;
    line-height: 1.5 !important;
  }
  .participants-table input[type="number"] {
    width: 60px !important;
    padding: 7px 5px !important;
    font-size: 16px !important;
  }
  .action-btn {
    padding: 7px 12px !important;
    font-size: 17px !important;
    margin: 2px !important;
  }
  .search-container input {
    font-size: 16px !important;
    padding: 11px 14px !important;
  }
  .task-item textarea {
    font-size: 15px !important;
    padding: 9px 12px !important;
  }
  h2.section-title {
    font-size: 1.7em !important;
  }
}
/* –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ —ç–∫—Ä–∞–Ω—ã */
@media (max-width: 375px) {
  .participants-table td:first-child,
  .participants-table th:first-child {
    min-width: 160px !important;
    font-size: 15px !important;
    padding: 11px 12px !important;
  }
  .participants-table th,
  .participants-table td {
    padding: 10px 8px !important;
    font-size: 14px !important;
  }
  .action-btn {
    padding: 6px 10px !important;
    font-size: 16px !important;
  }
  .sidebar button:not(.admin-toggle-sidebar) {
    padding: 12px 16px !important;
    font-size: 1em !important;
  }
}
/* –ü–µ—á–∞—Ç—å */
@media print {
  .sidebar, .mobile-menu-toggle, .sidebar-overlay, .btn, input[type="number"], .admin-column, .action-btn {
    display: none !important;
  }
  .main-content {
    padding: 0 !important;
    margin: 0 !important;
  }
  .participants-table {
    font-size: 12pt;
    border: 1px solid #000 !important;
  }
  .participants-table th {
    background-color: #000 !important;
    color: white !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
  .participants-table td {
    border: 1px solid #000 !important;
  }
}
/* –£–ª—É—á—à–µ–Ω–∏–µ —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
textarea, input[type="number"] {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
}
/* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫ */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}
.participants-table tbody tr {
  animation: fadeIn 0.3s ease-out;
  animation-fill-mode: both;
}
.participants-table tbody tr:nth-child(odd) {
  animation-delay: 0.05s;
}
.participants-table tbody tr:nth-child(even) {
  animation-delay: 0.1s;
}
</style>
</head>
<body>
<button class="mobile-menu-toggle" id="menuToggle">‚ò∞</button>
<div class="sidebar" id="sidebar">
  <h2>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ—Å–∫–∞</h2>
  <button data-target="participants" class="active">–£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
  <button data-target="sector-a">–ú–µ–¥–∏–∞</button>
  <button data-target="sector-b">–í–æ–ª–æ–Ω—Ç—ë—Ä—Å–∫–∏–π</button>
  <button data-target="sector-c">–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π</button>
  <button data-target="sector-d">–£—á–µ–±–Ω–æ-—Ç—Ä—É–¥–æ–≤–æ–π</button>
  <button data-target="sector-e">–î–æ—Å—É–≥–æ–≤—ã–π</button>
  <button data-target="sector-f">–í–æ–∂–∞—Ç—Å–∫–∏–π</button>
  <button class="admin-toggle-sidebar" id="adminToggleBtnSidebar">
    üîê –í–æ–π—Ç–∏ –≤ —Ä–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
  </button>
</div>
<div class="sidebar-overlay" id="sidebarOverlay"></div>
<div class="main-content">
  <div id="participants" class="section active">
    <h2 class="section-title">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h2>
    
    <div class="export-import admin-only">
      <button class="btn btn-sm admin-only" id="exportBtn">üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
      <button class="btn btn-sm admin-only" id="importBtn">üì• –ò–º–ø–æ—Ä—Ç –∏–∑ Excel</button>
      <input type="file" id="importFile" accept=".csv" style="display: none;" />
    </div>
    
    <div class="search-container">
      <input type="text" id="participantSearch" placeholder="üîç –ü–æ–∏—Å–∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞..." onkeyup="filterParticipants()">
    </div>
    
    <div class="table-wrapper">
      <table class="participants-table">
        <thead>
          <tr>
            <th>–§–ò–û —É—á–∞—Å—Ç–Ω–∏–∫–∞</th>
            <th>–ó–≤—ë–∑–¥—ã ‚≠ê</th>
            <th>–ß–µ—Ä–µ–ø–∫–∏ üíÄ</th>
            <th id="actionsHeader">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="participantsBody"></tbody>
      </table>
    </div>
    
    <button class="btn btn-add admin-only" id="addParticipantBtn" onclick="addNewParticipant()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</button>
  </div>

  <!-- –°–µ–∫—Ç–æ—Ä—ã -->
  <div id="sector-a" class="section">
    <h2 class="section-title">–ü–ª–∞–Ω –¥–µ–ª ‚Äî –ú–µ–¥–∏–∞</h2>
    <div class="task-controls task-controls-top" id="controls-top-a">
      <button class="btn btn-sm admin-only" id="toggleSelect-a">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
      <button class="btn btn-sm admin-only" id="deleteDoneTop-a">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
    </div>
    <ul id="tasks-a" class="task-list">
      <li class="no-tasks">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</li>
    </ul>
    <div class="task-controls">
      <button class="btn btn-sm admin-only" onclick="addTask('a')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
      <div class="admin-only admin-visible" style="display:flex;gap:10px;">
        <button class="btn btn-sm admin-only" id="toggleSelect-a-bottom">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
        <button class="btn btn-sm admin-only" id="deleteDoneBottom-a">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
      </div>
    </div>
  </div>
  
  <div id="sector-b" class="section">
    <h2 class="section-title">–ü–ª–∞–Ω –¥–µ–ª ‚Äî –í–æ–ª–æ–Ω—Ç—ë—Ä—Å–∫–∏–π</h2>
    <div class="task-controls task-controls-top" id="controls-top-b">
      <button class="btn btn-sm admin-only" id="toggleSelect-b">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
      <button class="btn btn-sm admin-only" id="deleteDoneTop-b">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
    </div>
    <ul id="tasks-b" class="task-list">
      <li class="no-tasks">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</li>
    </ul>
    <div class="task-controls">
      <button class="btn btn-sm admin-only" onclick="addTask('b')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
      <div class="admin-only admin-visible" style="display:flex;gap:10px;">
        <button class="btn btn-sm admin-only" id="toggleSelect-b-bottom">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
        <button class="btn btn-sm admin-only" id="deleteDoneBottom-b">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
      </div>
    </div>
  </div>
  
  <div id="sector-c" class="section">
    <h2 class="section-title">–ü–ª–∞–Ω –¥–µ–ª ‚Äî –°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π</h2>
    <div class="task-controls task-controls-top" id="controls-top-c">
      <button class="btn btn-sm admin-only" id="toggleSelect-c">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
      <button class="btn btn-sm admin-only" id="deleteDoneTop-c">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
    </div>
    <ul id="tasks-c" class="task-list">
      <li class="no-tasks">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</li>
    </ul>
    <div class="task-controls">
      <button class="btn btn-sm admin-only" onclick="addTask('c')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
      <div class="admin-only admin-visible" style="display:flex;gap:10px;">
        <button class="btn btn-sm admin-only" id="toggleSelect-c-bottom">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
        <button class="btn btn-sm admin-only" id="deleteDoneBottom-c">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
      </div>
    </div>
  </div>
  
  <div id="sector-d" class="section">
    <h2 class="section-title">–ü–ª–∞–Ω –¥–µ–ª ‚Äî –£—á–µ–±–Ω–æ-—Ç—Ä—É–¥–æ–≤–æ–π</h2>
    <div class="task-controls task-controls-top" id="controls-top-d">
      <button class="btn btn-sm admin-only" id="toggleSelect-d">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
      <button class="btn btn-sm admin-only" id="deleteDoneTop-d">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
    </div>
    <ul id="tasks-d" class="task-list">
      <li class="no-tasks">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</li>
    </ul>
    <div class="task-controls">
      <button class="btn btn-sm admin-only" onclick="addTask('d')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
      <div class="admin-only admin-visible" style="display:flex;gap:10px;">
        <button class="btn btn-sm admin-only" id="toggleSelect-d-bottom">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
        <button class="btn btn-sm admin-only" id="deleteDoneBottom-d">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
      </div>
    </div>
  </div>
  
  <div id="sector-e" class="section">
    <h2 class="section-title">–ü–ª–∞–Ω –¥–µ–ª ‚Äî –î–æ—Å—É–≥–æ–≤—ã–π</h2>
    <div class="task-controls task-controls-top" id="controls-top-e">
      <button class="btn btn-sm admin-only" id="toggleSelect-e">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
      <button class="btn btn-sm admin-only" id="deleteDoneTop-e">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
    </div>
    <ul id="tasks-e" class="task-list">
      <li class="no-tasks">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</li>
    </ul>
    <div class="task-controls">
      <button class="btn btn-sm admin-only" onclick="addTask('e')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
      <div class="admin-only admin-visible" style="display:flex;gap:10px;">
        <button class="btn btn-sm admin-only" id="toggleSelect-e-bottom">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
        <button class="btn btn-sm admin-only" id="deleteDoneBottom-e">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
      </div>
    </div>
  </div>
  
  <div id="sector-f" class="section">
    <h2 class="section-title">–ü–ª–∞–Ω –¥–µ–ª ‚Äî –í–æ–∂–∞—Ç—Å–∫–∏–π</h2>
    <div class="task-controls task-controls-top" id="controls-top-f">
      <button class="btn btn-sm admin-only" id="toggleSelect-f">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
      <button class="btn btn-sm admin-only" id="deleteDoneTop-f">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
    </div>
    <ul id="tasks-f" class="task-list">
      <li class="no-tasks">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</li>
    </ul>
    <div class="task-controls">
      <button class="btn btn-sm admin-only" onclick="addTask('f')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
      <div class="admin-only admin-visible" style="display:flex;gap:10px;">
        <button class="btn btn-sm admin-only" id="toggleSelect-f-bottom">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
        <button class="btn btn-sm admin-only" id="deleteDoneBottom-f">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDaxVRaPKFca3aiplOA-UwbUOwrrLlCr_A",
  authDomain: "website-dsho-legend.firebaseapp.com",
  databaseURL: "https://website-dsho-legend-default-rtdb.firebaseio.com",
  projectId: "website-dsho-legend",
  storageBucket: "website-dsho-legend.firebasestorage.app",
  messagingSenderId: "963395738991",
  appId: "1:963395738991:web:4f5ecd4277205a71389c9a",
  measurementId: "G-N8BVW01MVS"
};
firebase.initializeApp(firebaseConfig);
firebase.analytics();
const db = firebase.database();
const ADMIN_PASSWORD = "–ù–∞ –≥–æ—Ä—à–∫–µ —Å–∏–¥–µ–ª –∫–æ—Ä–æ–ª—å";
let isAdmin = false;
const ACTIVE_TAB_KEY = 'activeTab';
let currentTab = localStorage.getItem(ACTIVE_TAB_KEY) || 'participants';
let participantsList = [];
let participantsLoaded = false;
const sectorListeners = {};

function updateAdminUI() {
  document.querySelectorAll('.admin-only').forEach(el => {
    el.classList.toggle('admin-visible', isAdmin);
  });
  const actionsHeader = document.getElementById('actionsHeader');
  if (actionsHeader) actionsHeader.style.display = isAdmin ? '' : 'none';
}

function exportToCSV() {
  if (!isAdmin) return;
  let csv = '–ò–º—è,–ó–≤—ë–∑–¥—ã,–ß–µ—Ä–µ–ø–∫–∏\n';
  participantsList.forEach(p => {
    csv += `"${p.name.replace(/"/g, '""')}",${p.stars},${p.skulls}\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = '—É—á–∞—Å—Ç–Ω–∏–∫–∏_–ª–∏–¥–µ—Ä–±–æ—Ä–¥.csv';
  a.click();
  URL.revokeObjectURL(url);
}

function importFromCSV(file) {
  if (!isAdmin) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    const text = e.target.result;
    const lines = text.split('\n').filter(line => line.trim());
    if (lines.length < 2) {
      alert('–§–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.');
      return;
    }
    const header = lines[0].split(',').map(h => h.trim());
    if (header[0] !== '–ò–º—è' || header[1] !== '–ó–≤—ë–∑–¥—ã' || header[2] !== '–ß–µ—Ä–µ–ø–∫–∏') {
      alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –û–∂–∏–¥–∞—é—Ç—Å—è —Å—Ç–æ–ª–±—Ü—ã: –ò–º—è, –ó–≤—ë–∑–¥—ã, –ß–µ—Ä–µ–ø–∫–∏');
      return;
    }
    if (!confirm('‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –ò–º–ø–æ—Ä—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;
    const batch = db.ref().child('participants');
    batch.remove();
    setTimeout(() => {
      lines.slice(1).forEach(line => {
        const [name, stars, skulls] = line.split(',').map(s => s.trim().replace(/^"(.*)"$/, '$1'));
        if (name) {
          batch.push({
            name: name,
            stars: parseInt(stars) || 0,
            skulls: parseInt(skulls) || 0
          });
        }
      });
      alert('‚úÖ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!');
    }, 500);
  };
  reader.readAsText(file, 'utf-8');
}

function enterAdminMode() {
  const pass = prompt("üîí –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:");
  if (pass === ADMIN_PASSWORD) {
    isAdmin = true;
    document.querySelectorAll('.admin-toggle-sidebar').forEach(el => {
      el.innerHTML = "üîì –†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–∞–∫—Ç–∏–≤–µ–Ω)";
    });
    updateAdminUI();
    alert("‚úÖ –í—ã –≤–æ—à–ª–∏ –≤ —Ä–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.");
    initParticipantsTable();
    reinitAllTasks();
  } else if (pass !== null) {
    alert("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
  }
}

function exitAdminMode() {
  isAdmin = false;
  document.querySelectorAll('.admin-toggle-sidebar').forEach(el => {
    el.innerHTML = "üîê –í–æ–π—Ç–∏ –≤ —Ä–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞";
  });
  updateAdminUI();
  alert("‚úÖ –†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ—Ç–∫–ª—é—á—ë–Ω.");
  initParticipantsTable();
  reinitAllTasks();
}

function updateTaskControlsVisibility(sector) {
  const list = document.getElementById(`tasks-${sector}`);
  const topControls = document.getElementById(`controls-top-${sector}`);
  if (!list || !topControls) return;
  const noTasks = list.querySelector('.no-tasks');
  const hasTasks = list.children.length > (noTasks ? 1 : 0);
  if (hasTasks) {
    const listHeight = list.getBoundingClientRect().height;
    const viewportHeight = window.innerHeight;
    const shouldShow = listHeight > viewportHeight * 0.8;
    topControls.classList.toggle('task-controls-top-hidden', !shouldShow);
  } else {
    topControls.classList.add('task-controls-top-hidden');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const menuToggle = document.getElementById('menuToggle');
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  const adminBtn = document.getElementById('adminToggleBtnSidebar');
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const importFile = document.getElementById('importFile');
  
  if (adminBtn) {
    adminBtn.onclick = () => isAdmin ? exitAdminMode() : enterAdminMode();
  }
  if (exportBtn) {
    exportBtn.onclick = exportToCSV;
  }
  if (importBtn) {
    importBtn.onclick = () => importFile.click();
  }
  if (importFile) {
    importFile.onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        importFromCSV(file);
        importFile.value = '';
      }
    };
  }
  if (menuToggle) {
    menuToggle.addEventListener('click', () => {
      sidebar.classList.add('open');
      overlay.classList.add('active');
    });
  }
  const closeSidebar = () => {
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
  };
  overlay.addEventListener('click', closeSidebar);
  document.querySelectorAll('.sidebar button:not(.admin-toggle-sidebar)').forEach(btn => {
    btn.addEventListener('click', () => {
      if (window.innerWidth <= 767) {
        closeSidebar();
      }
    });
  });
  const searchInput = document.getElementById('participantSearch');
  if (searchInput) {
    searchInput.addEventListener('input', () => {
      const query = searchInput.value.trim().toLowerCase();
      const rows = document.querySelectorAll('#participantsBody tr');
      rows.forEach(row => {
        const name = row.querySelector('textarea')?.value || '';
        row.style.display = name.toLowerCase().includes(query) ? '' : 'none';
      });
    });
  }
  updateAdminUI();
});

function unsubscribeFromTasks(sector) {
  if (sectorListeners[sector]) {
    const { ref, handlers } = sectorListeners[sector];
    ref.off('child_added', handlers.added);
    ref.off('child_changed', handlers.changed);
    ref.off('child_removed', handlers.removed);
    delete sectorListeners[sector];
  }
}

function reinitAllTasks() {
  if (currentTab.startsWith('sector-')) {
    const sector = currentTab.split('-')[1];
    unsubscribeFromTasks(sector);
    document.getElementById(`tasks-${sector}`).innerHTML = '<li class="no-tasks">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</li>';
    initTasks(sector);
  }
}

function loadParticipants() {
  return new Promise((resolve) => {
    db.ref('participants').once('value', (snapshot) => {
      participantsList = [];
      const data = snapshot.val() || {};
      Object.entries(data).forEach(([key, p]) => {
        participantsList.push({ key, name: p.name || '', stars: p.stars || 0, skulls: p.skulls || 0 });
      });
      participantsLoaded = true;
      renderParticipantsTable();
      resolve();
    });
  });
}

function renderParticipantsTable() {
  const tbody = document.getElementById('participantsBody');
  tbody.innerHTML = '';
  const sorted = [...participantsList].sort((a, b) => (b.stars - b.skulls * 10) - (a.stars - a.skulls * 10));
  sorted.forEach(p => {
    const row = document.createElement('tr');
    row.dataset.key = p.key;
    
    // –§–ò–û —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –≤–∏–¥–∏–º–æ—Å—Ç—å—é
    const nameCell = document.createElement('td');
    const nameTextarea = document.createElement('textarea');
    nameTextarea.value = p.name;
    nameTextarea.rows = 1;
    nameTextarea.style.resize = 'none';
    nameTextarea.style.overflow = 'hidden';
    nameTextarea.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    nameTextarea.style.fontSize = '16px';
    nameTextarea.style.padding = '8px 12px';
    nameTextarea.style.border = '2px solid #bdc3c7';
    nameTextarea.style.borderRadius = '6px';
    nameTextarea.style.textAlign = 'left';
    nameTextarea.style.minHeight = '36px';
    nameTextarea.style.width = '100%';
    nameTextarea.style.backgroundColor = 'white';
    nameTextarea.style.color = '#2c3e50';
    nameTextarea.style.fontWeight = '500';
    nameTextarea.disabled = !isAdmin;
    
    const autoSizeName = () => {
      nameTextarea.style.height = 'auto';
      nameTextarea.style.height = Math.max(36, nameTextarea.scrollHeight) + 'px';
    };
    autoSizeName();
    
    if (isAdmin) {
      nameTextarea.addEventListener('input', autoSizeName);
      nameTextarea.addEventListener('blur', () => {
        db.ref(`participants/${p.key}/name`).set(nameTextarea.value.trim() || '–ë–µ–∑ –∏–º–µ–Ω–∏');
      });
    }
    nameCell.appendChild(nameTextarea);
    
    // –ó–≤—ë–∑–¥—ã
    const starsCell = document.createElement('td');
    const starsInput = document.createElement('input');
    starsInput.type = 'number';
    starsInput.min = '0';
    starsInput.value = p.stars;
    starsInput.disabled = !isAdmin;
    starsInput.style.width = '100%';
    if (isAdmin) {
      starsInput.addEventListener('blur', () => {
        const val = Math.max(0, parseInt(starsInput.value) || 0);
        db.ref(`participants/${p.key}/stars`).set(val);
        starsInput.value = val;
      });
      starsInput.addEventListener('focus', (e) => {
        e.target.dataset.scrollY = window.scrollY;
      });
      starsInput.addEventListener('blur', (e) => {
        setTimeout(() => {
          window.scrollTo(0, e.target.dataset.scrollY);
        }, 10);
      });
      starsInput.addEventListener('dblclick', () => {
        const newVal = p.stars + 1;
        db.ref(`participants/${p.key}/stars`).set(newVal);
      });
    }
    starsCell.appendChild(starsInput);
    
    // –ß–µ—Ä–µ–ø–∫–∏
    const skullsCell = document.createElement('td');
    const skullsInput = document.createElement('input');
    skullsInput.type = 'number';
    skullsInput.min = '0';
    skullsInput.value = p.skulls;
    skullsInput.disabled = !isAdmin;
    skullsInput.style.width = '100%';
    if (isAdmin) {
      skullsInput.addEventListener('blur', () => {
        const val = Math.max(0, parseInt(skullsInput.value) || 0);
        db.ref(`participants/${p.key}/skulls`).set(val);
        skullsInput.value = val;
      });
      skullsInput.addEventListener('focus', (e) => {
        e.target.dataset.scrollY = window.scrollY;
      });
      skullsInput.addEventListener('blur', (e) => {
        setTimeout(() => {
          window.scrollTo(0, e.target.dataset.scrollY);
        }, 10);
      });
    }
    skullsCell.appendChild(skullsInput);
    
    // –î–µ–π—Å—Ç–≤–∏—è
    const actionsCell = document.createElement('td');
    if (isAdmin) {
      const chocolateBtn = document.createElement('button');
      chocolateBtn.textContent = 'üç´';
      chocolateBtn.title = '–ü–æ—Ç—Ä–∞—Ç–∏—Ç—å 10 –∑–≤—ë–∑–¥';
      chocolateBtn.className = 'action-btn star-btn';
      chocolateBtn.disabled = p.stars < 10;
      chocolateBtn.onclick = () => p.stars >= 10 ? db.ref(`participants/${p.key}/stars`).set(p.stars - 10) : alert('–ù—É–∂–Ω–æ 10+ –∑–≤—ë–∑–¥!');
      actionsCell.appendChild(chocolateBtn);
      
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'üóëÔ∏è';
      deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å';
      deleteBtn.className = 'action-btn delete-btn';
      deleteBtn.onclick = () => confirm(`–£–¥–∞–ª–∏—Ç—å "${p.name}"?`) && db.ref(`participants/${p.key}`).remove();
      actionsCell.appendChild(deleteBtn);
    }
    actionsCell.style.display = isAdmin ? 'flex' : 'none';
    actionsCell.style.justifyContent = 'center';
    actionsCell.style.gap = '6px';
    actionsCell.style.padding = '6px';
    
    row.append(nameCell, starsCell, skullsCell, actionsCell);
    tbody.appendChild(row);
  });
  
  const searchInput = document.getElementById('participantSearch');
  if (searchInput) {
    const event = new Event('input');
    searchInput.dispatchEvent(event);
  }
}

function initParticipantsTable() {
  db.ref('participants').on('value', (snapshot) => {
    participantsList = [];
    const data = snapshot.val() || {};
    Object.entries(data).forEach(([key, p]) => {
      participantsList.push({ key, name: p.name || '', stars: p.stars || 0, skulls: p.skulls || 0 });
    });
    renderParticipantsTable();
  });
}

async function initTasks(sector) {
  if (!participantsLoaded) await loadParticipants();
  const list = document.getElementById(`tasks-${sector}`);
  const topControls = document.getElementById(`controls-top-${sector}`);
  const bottomControls = Array.from(document.querySelectorAll(`#sector-${sector} .task-controls`)).pop();
  
  list.innerHTML = '<li class="no-tasks">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</li>';
  if (topControls) topControls.classList.add('task-controls-top-hidden');
  
  // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫ –∫–Ω–æ–ø–∫–∞–º —Å–≤–µ—Ä—Ö—É
  const toggleTop = document.getElementById(`toggleSelect-${sector}`);
  const deleteTop = document.getElementById(`deleteDoneTop-${sector}`);
  if (toggleTop) {
    toggleTop.onclick = () => toggleSelectAll(sector);
  }
  if (deleteTop) {
    deleteTop.onclick = () => {
      if (!isAdmin || !confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏?')) return;
      db.ref(`tasks/${sector}`).once('value', (snapshot) => {
        const tasks = snapshot.val() || {};
        Object.entries(tasks).forEach(([key, task]) => {
          if (task.done) db.ref(`tasks/${sector}/${key}`).remove();
        });
      });
    };
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∏–∂–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
  if (bottomControls) {
    bottomControls.innerHTML = `
      <button class="btn btn-sm admin-only" onclick="addTask('${sector}')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
      <div class="admin-only admin-visible" style="display:flex;gap:10px;">
        <button class="btn btn-sm admin-only" id="toggleSelect-${sector}-bottom">–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë</button>
        <button class="btn btn-sm admin-only" id="deleteDoneBottom-${sector}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
      </div>
    `;
    const toggleBottom = document.getElementById(`toggleSelect-${sector}-bottom`);
    const deleteBottom = document.getElementById(`deleteDoneBottom-${sector}`);
    if (toggleBottom) toggleBottom.onclick = () => toggleSelectAll(sector);
    if (deleteBottom) {
      deleteBottom.onclick = () => {
        if (!isAdmin || !confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏?')) return;
        db.ref(`tasks/${sector}`).once('value', (snapshot) => {
          const tasks = snapshot.val() || {};
          Object.entries(tasks).forEach(([key, task]) => {
            if (task.done) db.ref(`tasks/${sector}/${key}`).remove();
          });
        });
      };
    }
  }
  
  updateAdminUI();
  
  const ref = db.ref(`tasks/${sector}`);
  const handlers = {
    added: (snapshot) => {
      if (list.querySelector('.no-tasks')) {
        list.innerHTML = '';
      }
      renderTask(sector, snapshot.key, snapshot.val());
      setTimeout(() => updateTaskControlsVisibility(sector), 100);
    },
    changed: (snapshot) => {
      const li = list.querySelector(`li[data-key="${snapshot.key}"]`);
      if (li) {
        updateTask(sector, snapshot.key, snapshot.val(), li);
      } else {
        if (list.querySelector('.no-tasks')) list.innerHTML = '';
        renderTask(sector, snapshot.key, snapshot.val());
      }
      setTimeout(() => updateTaskControlsVisibility(sector), 100);
    },
    removed: (snapshot) => {
      const li = list.querySelector(`li[data-key="${snapshot.key}"]`);
      if (li) li.remove();
      if (list.children.length === 0) {
        list.innerHTML = '<li class="no-tasks">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</li>';
      }
      setTimeout(() => updateTaskControlsVisibility(sector), 100);
    }
  };
  
  ref.on('child_added', handlers.added);
  ref.on('child_changed', handlers.changed);
  ref.on('child_removed', handlers.removed);
  sectorListeners[sector] = { ref, handlers };
}

function renderTask(sector, taskKey, data) {
  const list = document.getElementById(`tasks-${sector}`);
  if (list.querySelector('.no-tasks')) {
    list.innerHTML = '';
  }
  
  const li = document.createElement('li');
  li.className = 'task-item';
  li.dataset.key = taskKey;
  
  const checkbox = document.createElement('input');
  checkbox.type = 'checkbox';
  checkbox.checked = data.done || false;
  checkbox.disabled = !isAdmin;
  checkbox.className = 'task-checkbox';
  if (isAdmin) {
    checkbox.addEventListener('change', () => {
      db.ref(`tasks/${sector}/${taskKey}/done`).set(checkbox.checked);
    });
  }
  
  const contentDiv = document.createElement('div');
  contentDiv.className = 'task-content';
  
  if (isAdmin) {
    const textInput = document.createElement('textarea');
    textInput.value = data.text || '';
    textInput.placeholder = '–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏';
    textInput.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    textInput.style.fontSize = '16px';
    textInput.style.color = '#2c3e50';
    
    const autoSize = () => {
      textInput.style.height = 'auto';
      textInput.style.height = Math.max(40, textInput.scrollHeight) + 'px';
    };
    autoSize();
    textInput.addEventListener('input', autoSize);
    textInput.addEventListener('blur', () => {
      db.ref(`tasks/${sector}/${taskKey}/text`).set(textInput.value);
    });
    contentDiv.appendChild(textInput);
  } else {
    const textDisplay = document.createElement('div');
    textDisplay.className = 'task-text-display';
    textDisplay.textContent = data.text || '';
    textDisplay.style.fontSize = '16px';
    textDisplay.style.color = '#2c3e50';
    textDisplay.style.lineHeight = '1.5';
    contentDiv.appendChild(textDisplay);
  }
  
  if (data.assignees?.length > 0) {
    const assigneesDiv = document.createElement('div');
    assigneesDiv.className = 'task-assignees';
    const names = data.assignees.map(k => participantsList.find(p => p.key === k)?.name || '???').join(', ');
    assigneesDiv.textContent = `–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏: ${names}`;
    contentDiv.appendChild(assigneesDiv);
  }
  
  if (isAdmin) {
    const assignBtn = document.createElement('button');
    assignBtn.textContent = 'üë• –ù–∞–∑–Ω–∞—á–∏—Ç—å';
    assignBtn.className = 'btn btn-sm admin-only admin-visible';
    assignBtn.style.marginTop = '6px';
    assignBtn.onclick = (e) => {
      e.stopPropagation();
      document.querySelectorAll('.assign-dropdown').forEach(el => el.remove());
      
      const dropdown = document.createElement('div');
      dropdown.className = 'assign-dropdown';
      
      const rect = assignBtn.getBoundingClientRect();
      dropdown.style.position = 'absolute';
      dropdown.style.left = rect.left + 'px';
      dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
      dropdown.style.zIndex = '2000';
      dropdown.style.background = 'white';
      dropdown.style.border = '1px solid #ccc';
      dropdown.style.borderRadius = '8px';
      dropdown.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)';
      dropdown.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
      dropdown.style.fontSize = '14px';
      dropdown.style.width = '240px';
      dropdown.style.maxHeight = '320px';
      
      const scrollContainer = document.createElement('div');
      scrollContainer.style.maxHeight = '240px';
      scrollContainer.style.overflowY = 'auto';
      scrollContainer.style.padding = '10px';
      
      const current = data.assignees || [];
      participantsList.forEach(p => {
        const label = document.createElement('label');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = p.key;
        cb.checked = current.includes(p.key);
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.margin = '6px 0';
        label.style.cursor = 'pointer';
        label.style.padding = '4px 6px';
        label.style.borderRadius = '4px';
        label.onmouseover = () => label.style.backgroundColor = '#f5f7fa';
        label.onmouseout = () => label.style.backgroundColor = '';
        label.append(cb, document.createTextNode(` ${p.name}`));
        scrollContainer.appendChild(label);
      });
      
      const done = document.createElement('button');
      done.textContent = '–ì–æ—Ç–æ–≤–æ';
      done.className = 'btn';
      done.style.width = 'calc(100% - 20px)';
      done.style.margin = '10px';
      done.style.fontSize = '14px';
      done.onclick = () => {
        const sel = Array.from(dropdown.querySelectorAll('input:checked')).map(cb => cb.value);
        db.ref(`tasks/${sector}/${taskKey}/assignees`).set(sel.length ? sel : null);
        dropdown.remove();
      };
      
      dropdown.appendChild(scrollContainer);
      dropdown.appendChild(done);
      document.body.appendChild(dropdown);
      
      const close = (e) => {
        if (!dropdown.contains(e.target) && e.target !== assignBtn) {
          dropdown.remove();
          document.removeEventListener('click', close);
        }
      };
      document.addEventListener('click', close);
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ
      let lastScroll = window.scrollY;
      window.addEventListener('scroll', function scrollHandler() {
        if (Math.abs(window.scrollY - lastScroll) > 10) {
          dropdown.remove();
          window.removeEventListener('scroll', scrollHandler);
          document.removeEventListener('click', close);
        }
      });
    };
    
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'task-actions admin-only admin-visible';
    actionsDiv.style.width = '100%';
    actionsDiv.appendChild(assignBtn);
    contentDiv.appendChild(actionsDiv);
  }
  
  li.appendChild(checkbox);
  li.appendChild(contentDiv);
  list.appendChild(li);
}

function updateTask(sector, taskKey, data, li) {
  const checkbox = li.querySelector('.task-checkbox');
  if (checkbox) {
    checkbox.checked = data.done || false;
    checkbox.disabled = !isAdmin;
  }
  
  const textDisplay = li.querySelector('.task-text-display');
  const textArea = li.querySelector('textarea');
  if (isAdmin && textArea) {
    if (document.activeElement !== textArea) {
      textArea.value = data.text || '';
      textArea.style.height = 'auto';
      textArea.style.height = Math.max(40, textArea.scrollHeight) + 'px';
    }
  } else if (!isAdmin && textDisplay) {
    textDisplay.textContent = data.text || '';
  }
  
  const assigneesDiv = li.querySelector('.task-assignees');
  if (assigneesDiv) {
    if (data.assignees?.length > 0) {
      const names = data.assignees.map(k => participantsList.find(p => p.key === k)?.name || '???').join(', ');
      assigneesDiv.textContent = `–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏: ${names}`;
    } else {
      assigneesDiv.remove();
    }
  } else if (data.assignees?.length > 0 && !assigneesDiv) {
    const contentDiv = li.querySelector('.task-content');
    const newAssignees = document.createElement('div');
    newAssignees.className = 'task-assignees';
    const names = data.assignees.map(k => participantsList.find(p => p.key === k)?.name || '???').join(', ');
    newAssignees.textContent = `–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏: ${names}`;
    contentDiv.appendChild(newAssignees);
  }
}

function toggleSelectAll(sector) {
  if (!isAdmin) return;
  const list = document.getElementById(`tasks-${sector}`);
  const checkboxes = list.querySelectorAll('.task-checkbox');
  if (checkboxes.length === 0) return;
  
  const allChecked = Array.from(checkboxes).every(cb => cb.checked);
  const newState = !allChecked;
  checkboxes.forEach(cb => {
    cb.checked = newState;
    db.ref(`tasks/${sector}/${cb.closest('li').dataset.key}/done`).set(newState);
  });
  
  const buttons = document.querySelectorAll(
    `#toggleSelect-${sector}, #toggleSelect-${sector}-bottom`
  );
  buttons.forEach(btn => {
    btn.textContent = newState ? '–°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ' : '–í—ã–¥–µ–ª–∏—Ç—å –≤—Å—ë';
  });
}

function switchTab(target) {
  document.querySelectorAll('.sidebar button:not(.admin-toggle-sidebar)').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  const btn = document.querySelector(`.sidebar button[data-target="${target}"]`);
  btn?.classList.add('active');
  document.getElementById(target)?.classList.add('active');
  localStorage.setItem(ACTIVE_TAB_KEY, target);
  currentTab = target;
  
  if (target.startsWith('sector-')) {
    const sector = target.split('-')[1];
    unsubscribeFromTasks(sector);
    document.getElementById(`tasks-${sector}`).innerHTML = '<li class="no-tasks">–ó–∞–¥–∞–Ω–∏–π –Ω–µ—Ç</li>';
    initTasks(sector);
  }
}

function scrollToBottom() {
  setTimeout(() => {
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  }, 100);
}

window.addNewParticipant = () => {
  if (!isAdmin) return enterAdminMode();
  const name = prompt("–§–ò–û —É—á–∞—Å—Ç–Ω–∏–∫–∞:", "–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫");
  if (name?.trim()) {
    db.ref('participants').push({ name: name.trim(), stars: 0, skulls: 0 });
    scrollToBottom();
  }
};

window.addTask = (sector) => {
  if (!isAdmin) return enterAdminMode();
  const text = prompt("–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:", "–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞");
  if (text?.trim()) {
    db.ref(`tasks/${sector}`).push({ text: text.trim(), done: false, assignees: null });
    scrollToBottom();
  }
};

window.filterParticipants = () => {
  const input = document.getElementById('participantSearch');
  const filter = input.value.toUpperCase();
  const table = document.querySelector('.participants-table');
  const tr = table.getElementsByTagName('tr');
  
  for (let i = 0; i < tr.length; i++) {
    const td = tr[i].getElementsByTagName('td')[0];
    if (td) {
      const txtValue = td.textContent || td.innerText || td.querySelector('textarea')?.value || '';
      if (txtValue.toUpperCase().indexOf(filter) > -1) {
        tr[i].style.display = '';
      } else {
        tr[i].style.display = 'none';
      }
    }
  }
};

document.addEventListener('DOMContentLoaded', async () => {
  await loadParticipants();
  document.querySelectorAll('.sidebar button:not(.admin-toggle-sidebar)').forEach(btn => {
    if (!btn.dataset.clickBound) {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        switchTab(btn.dataset.target);
      });
      btn.dataset.clickBound = 'true';
    }
  });
  switchTab(currentTab);
  initParticipantsTable();
});
</script>
</body>
</html>
