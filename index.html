<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ—Å–∫–∞</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 220px;
      background: #2c3e50;
      color: white;
      padding: 20px 0;
    }
    .sidebar h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.2em;
    }
    .sidebar button {
      display: block;
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 8px;
      background: transparent;
      color: white;
      border: none;
      text-align: left;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.2s;
    }
    .sidebar button:hover,
    .sidebar button.active {
      background: #34495e;
    }
    .main-content {
      flex: 1;
      padding: 25px;
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    h2.section-title {
      margin-top: 0;
      color: #2c3e50;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      text-align: center;
      border: 1px solid #ccc;
    }
    th {
      background-color: #ecf0f1;
    }
    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 6px;
      border: 1px solid #999;
      border-radius: 4px;
      text-align: center;
    }
    input[type="number"] {
      width: 70px;
    }
    .task-list {
      list-style: none;
      padding: 0;
    }
    .task-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      padding: 8px 0;
    }
    .task-item input[type="checkbox"] {
      margin-right: 10px;
    }
    .task-item input[type="text"] {
      flex: 1;
      padding: 8px;
    }
    .btn {
      padding: 8px 12px;
      margin-top: 10px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn:hover {
      background: #2980b9;
    }
    .btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .assign-dropdown {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
      z-index: 1001;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      min-width: 200px;
      max-height: 250px;
      overflow-y: auto;
    }
    .assign-dropdown label {
      display: block;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <h2>–ù–∞–≤–∏–≥–∞—Ü–∏—è</h2>
    <button data-target="participants" class="active">–£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
    <button data-target="sector-a">–ú–µ–¥–∏–∞</button>
    <button data-target="sector-b">–í–æ–ª–æ–Ω—Ç—ë—Ä—Å–∫–∏–π</button>
    <button data-target="sector-c">–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π</button>
    <button data-target="sector-d">–£—á–µ–±–Ω–æ-—Ç—Ä—É–¥–æ–≤–æ–π</button>
    <button data-target="sector-e">–î–æ—Å—É–≥–æ–≤—ã–π</button>
    <button data-target="sector-f">–í–æ–∂–∞—Ç—Å–∫–∏–π</button>
  </div>

  <div class="main-content">
    
    <div id="participants" class="section active">
      <h2 class="section-title">–£—á–∞—Å—Ç–Ω–∏–∫–∏ </h2>
      <button class="btn" id="adminToggleBtn" style="margin-bottom: 15px;">üîê –í–æ–π—Ç–∏ –≤ —Ä–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</button>
      <table>
        <thead>
          <tr>
            <th>–ò–º—è</th>
            <th>–ó–≤—ë–∑–¥—ã ‚≠ê</th>
            <th>–ß–µ—Ä–µ–ø–∫–∏ üíÄ</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="participantsBody"></tbody>
      </table>
      <button class="btn" onclick="addNewParticipant()">+ –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</button>
    </div>

    <div id="sector-a" class="section">
      <h2 class="section-title">–ü–ª–∞–Ω –¥–µ–ª ‚Äî –ú–µ–¥–∏–∞</h2>
      <ul id="tasks-a" class="task-list"></ul>
      <button class="btn" onclick="addTask('a')">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
    </div>

    <div id="sector-b" class="section">
      <h2 class="section-title">–ü–ª–∞–Ω –¥–µ–ª ‚Äî –í–æ–ª–æ–Ω—Ç—ë—Ä—Å–∫–∏–π</h2>
      <ul id="tasks-b" class="task-list"></ul>
      <button class="btn" onclick="addTask('b')">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
    </div>

    <div id="sector-c" class="section">
      <h2 class="section-title">–ü–ª–∞–Ω –¥–µ–ª ‚Äî –°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π</h2>
      <ul id="tasks-c" class="task-list"></ul>
      <button class="btn" onclick="addTask('c')">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
    </div>

    <div id="sector-d" class="section">
      <h2 class="section-title">–ü–ª–∞–Ω –¥–µ–ª ‚Äî –£—á–µ–±–Ω–æ-—Ç—Ä—É–¥–æ–≤–æ–π</h2>
      <ul id="tasks-d" class="task-list"></ul>
      <button class="btn" onclick="addTask('d')">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
    </div>

    <div id="sector-e" class="section">
      <h2 class="section-title">–ü–ª–∞–Ω –¥–µ–ª ‚Äî –î–æ—Å—É–≥–æ–≤—ã–π</h2>
      <ul id="tasks-e" class="task-list"></ul>
      <button class="btn" onclick="addTask('e')">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
    </div>

    <div id="sector-f" class="section">
      <h2 class="section-title">–ü–ª–∞–Ω –¥–µ–ª ‚Äî –í–æ–∂–∞—Ç—Å–∫–∏–π</h2>
      <ul id="tasks-f" class="task-list"></ul>
      <button class="btn" onclick="addTask('f')">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
    </div>

  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDaxVRaPKFca3aiplOA-UwbUOwrrLlCr_A",
    authDomain: "website-dsho-legend.firebaseapp.com",
    databaseURL: "https://website-dsho-legend-default-rtdb.firebaseio.com",
    projectId: "website-dsho-legend",
    storageBucket: "website-dsho-legend.firebasestorage.app",
    messagingSenderId: "963395738991",
    appId: "1:963395738991:web:4f5ecd4277205a71389c9a",
    measurementId: "G-N8BVW01MVS"
  };

  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
  const db = firebase.database();

  const ADMIN_PASSWORD = "admin123"; // ‚Üê –∑–∞–º–µ–Ω–∏—Ç–µ!
  let isAdmin = false;

  const ACTIVE_TAB_KEY = 'activeTab';
  let currentTab = localStorage.getItem(ACTIVE_TAB_KEY) || 'participants';
  let participantsList = [];
  let participantsLoaded = false;
  const sectorListeners = {}; // ‚Üê —Ö—Ä–∞–Ω–∏–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –æ—Ç–ø–∏—Å–∫–∏

  // === –£—Ç–∏–ª–∏—Ç–∞: –æ—Ç–ø–∏—Å–∫–∞ –æ—Ç –∑–∞–¥–∞—á —Å–µ–∫—Ç–æ—Ä–∞ ===
  function unsubscribeFromTasks(sector) {
    if (sectorListeners[sector]) {
      const { ref, handlers } = sectorListeners[sector];
      ref.off('child_added', handlers.added);
      ref.off('child_changed', handlers.changed);
      ref.off('child_removed', handlers.removed);
      delete sectorListeners[sector];
    }
  }

  // === –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –∑–∞–¥–∞—á —Å –æ—Ç–ø–∏—Å–∫–æ–π ===
  function reinitAllTasks() {
    if (currentTab.startsWith('sector-')) {
      const sector = currentTab.split('-')[1];
      unsubscribeFromTasks(sector);
      document.getElementById(`tasks-${sector}`).innerHTML = '';
      const deleteBtn = document.querySelector('.delete-done-btn');
      if (deleteBtn) deleteBtn.remove();
      initTasks(sector);
    }
  }

  function enterAdminMode() {
    const pass = prompt("üîí –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:");
    if (pass === ADMIN_PASSWORD) {
      isAdmin = true;
      document.getElementById('adminToggleBtn').textContent = "üîì –†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–∞–∫—Ç–∏–≤–µ–Ω)";
      alert("‚úÖ –í—ã –≤–æ—à–ª–∏ –≤ —Ä–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.");
      initParticipantsTable();
      reinitAllTasks();
    } else if (pass !== null) {
      alert("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
    }
  }

  function exitAdminMode() {
    isAdmin = false;
    document.getElementById('adminToggleBtn').textContent = "üîê –í–æ–π—Ç–∏ –≤ —Ä–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞";
    alert("‚úÖ –†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ—Ç–∫–ª—é—á—ë–Ω.");
    initParticipantsTable();
    reinitAllTasks();
  }

  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('adminToggleBtn');
    if (btn) {
      btn.onclick = () => isAdmin ? exitAdminMode() : enterAdminMode();
    }
  });

  // === –£—á–∞—Å—Ç–Ω–∏–∫–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ===
  function loadParticipants() {
    return new Promise((resolve) => {
      db.ref('participants').once('value', (snapshot) => {
        participantsList = [];
        const data = snapshot.val() || {};
        Object.entries(data).forEach(([key, p]) => {
          participantsList.push({ key, name: p.name || '', stars: p.stars || 0, skulls: p.skulls || 0 });
        });
        participantsLoaded = true;
        resolve();
      });
    });
  }

  function renderParticipantsTable() {
    const tbody = document.getElementById('participantsBody');
    tbody.innerHTML = '';

    const sorted = [...participantsList].sort((a, b) => (b.stars - b.skulls * 10) - (a.stars - a.skulls * 10));
    sorted.forEach(p => {
      const row = document.createElement('tr');
      row.dataset.key = p.key;

      // –ò–º—è
      const nameCell = document.createElement('td');
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = p.name;
      nameInput.disabled = !isAdmin;
      if (isAdmin) nameInput.addEventListener('input', () => db.ref(`participants/${p.key}/name`).set(nameInput.value));
      nameCell.appendChild(nameInput);

      // –ó–≤—ë–∑–¥—ã
      const starsCell = document.createElement('td');
      const starsInput = document.createElement('input');
      starsInput.type = 'number';
      starsInput.min = '0';
      starsInput.value = p.stars;
      starsInput.disabled = !isAdmin;
      if (isAdmin) starsInput.addEventListener('input', () => db.ref(`participants/${p.key}/stars`).set(Math.max(0, parseInt(starsInput.value) || 0)));
      starsCell.appendChild(starsInput);

      // –ß–µ—Ä–µ–ø–∫–∏
      const skullsCell = document.createElement('td');
      const skullsInput = document.createElement('input');
      skullsInput.type = 'number';
      skullsInput.min = '0';
      skullsInput.value = p.skulls;
      skullsInput.disabled = !isAdmin;
      if (isAdmin) skullsInput.addEventListener('input', () => db.ref(`participants/${p.key}/skulls`).set(Math.max(0, parseInt(skullsInput.value) || 0)));
      skullsCell.appendChild(skullsInput);

      // –î–µ–π—Å—Ç–≤–∏—è
      const actionsCell = document.createElement('td');
      const chocolateBtn = document.createElement('button');
      chocolateBtn.textContent = 'üç´';
      chocolateBtn.className = 'btn';
      chocolateBtn.style.padding = '4px 6px';
      chocolateBtn.style.fontSize = '12px';
      chocolateBtn.style.marginRight = '4px';
      chocolateBtn.disabled = !isAdmin || p.stars < 10;
      if (isAdmin) chocolateBtn.onclick = () => p.stars >= 10 ? db.ref(`participants/${p.key}/stars`).set(p.stars - 10) : alert('–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 10 –∑–≤—ë–∑–¥!');
      actionsCell.appendChild(chocolateBtn);

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'üóëÔ∏è';
      deleteBtn.className = 'btn';
      deleteBtn.style.padding = '4px 6px';
      deleteBtn.style.fontSize = '12px';
      deleteBtn.disabled = !isAdmin;
      if (isAdmin) deleteBtn.onclick = () => confirm(`–£–¥–∞–ª–∏—Ç—å "${p.name}"?`) && db.ref(`participants/${p.key}`).remove();
      actionsCell.appendChild(deleteBtn);

      row.append(nameCell, starsCell, skullsCell, actionsCell);
      tbody.appendChild(row);
    });
  }

  function initParticipantsTable() {
    db.ref('participants').on('value', (snapshot) => {
      participantsList = [];
      const data = snapshot.val() || {};
      Object.entries(data).forEach(([key, p]) => {
        participantsList.push({ key, name: p.name || '', stars: p.stars || 0, skulls: p.skulls || 0 });
      });
      renderParticipantsTable();
    });
  }

  // === –ó–ê–î–ê–ß–ò: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–≤–æ–¥ ===
  async function initTasks(sector) {
    if (!participantsLoaded) await loadParticipants();

    const container = document.getElementById(`sector-${sector}`);
    let deleteBtn = container.querySelector('.delete-done-btn');
    if (deleteBtn) deleteBtn.remove();
    if (isAdmin) {
      deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn delete-done-btn';
      deleteBtn.textContent = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ';
      deleteBtn.style.marginLeft = '10px';
      deleteBtn.onclick = () => {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ?')) return;
        db.ref(`tasks/${sector}`).once('value', (snapshot) => {
          const tasks = snapshot.val() || {};
          Object.entries(tasks).forEach(([key, task]) => task.done && db.ref(`tasks/${sector}/${key}`).remove());
        });
      };
      container.querySelector('.btn').after(deleteBtn);
    }

    const ref = db.ref(`tasks/${sector}`);
    const handlers = {
      added: (snapshot) => renderTask(sector, snapshot.key, snapshot.val()),
      changed: (snapshot) => {
        const li = document.querySelector(`#tasks-${sector} li[data-key="${snapshot.key}"]`);
        if (li) updateTask(sector, snapshot.key, snapshot.val(), li);
      },
      removed: (snapshot) => {
        const li = document.querySelector(`#tasks-${sector} li[data-key="${snapshot.key}"]`);
        if (li) li.remove();
      }
    };

    ref.on('child_added', handlers.added);
    ref.on('child_changed', handlers.changed);
    ref.on('child_removed', handlers.removed);

    sectorListeners[sector] = { ref, handlers };
  }

  // === –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ ===
  function renderTask(sector, taskKey, data) {
    const li = document.createElement('li');
    li.className = 'task-item';
    li.dataset.key = taskKey;

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = data.done || false;
    checkbox.disabled = !isAdmin;
    if (isAdmin) checkbox.addEventListener('change', () => db.ref(`tasks/${sector}/${taskKey}/done`).set(checkbox.checked));
    li.appendChild(checkbox);

    const textInput = document.createElement('input');
    textInput.type = 'text';
    textInput.placeholder = '–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏';
    textInput.value = data.text || '';
    textInput.disabled = !isAdmin;
    if (isAdmin) textInput.addEventListener('input', () => db.ref(`tasks/${sector}/${taskKey}/text`).set(textInput.value));
    li.appendChild(textInput);

    const assigneesDiv = document.createElement('div');
    assigneesDiv.className = 'task-assignees';
    assigneesDiv.style.cssText = 'font-size:13px; margin-top:4px; margin-left:28px;';
    if (data.assignees?.length > 0) {
      const names = data.assignees.map(k => participantsList.find(p => p.key === k)?.name || '???').join(', ');
      assigneesDiv.textContent = `–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏: ${names}`;
    } else {
      assigneesDiv.textContent = '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã';
      assigneesDiv.style.color = '#999';
    }
    li.appendChild(assigneesDiv);

    if (isAdmin) {
      const assignBtn = document.createElement('button');
      assignBtn.textContent = 'üë• –ù–∞–∑–Ω–∞—á–∏—Ç—å';
      assignBtn.className = 'btn';
      assignBtn.style.cssText = 'font-size:12px; padding:4px 8px; margin-left:8px;';
      assignBtn.onclick = (e) => {
        e.stopPropagation();
        document.querySelectorAll('.assign-dropdown').forEach(el => el.remove());

        const dropdown = document.createElement('div');
        dropdown.className = 'assign-dropdown';
        const rect = assignBtn.getBoundingClientRect();
        dropdown.style.cssText = `
          position: absolute;
          top: ${rect.bottom + window.scrollY}px;
          left: ${rect.left + window.scrollX}px;
          background: white;
          border: 1px solid #ccc;
          border-radius: 4px;
          padding: 8px;
          z-index: 1001;
          box-shadow: 0 2px 6px rgba(0,0,0,0.2);
          min-width: 200px;
          max-height: 250px;
          overflow-y: auto;
        `;

        const current = data.assignees || [];
        participantsList.forEach(p => {
          const label = document.createElement('label');
          label.style.display = 'block';
          label.style.marginBottom = '4px';
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.value = p.key;
          cb.checked = current.includes(p.key);
          label.append(cb, document.createTextNode(` ${p.name}`));
          dropdown.appendChild(label);
        });

        const done = document.createElement('button');
        done.textContent = '–ì–æ—Ç–æ–≤–æ';
        done.className = 'btn';
        done.style.cssText = 'width:100%; margin-top:8px; font-size:13px;';
        done.onclick = () => {
          const sel = Array.from(dropdown.querySelectorAll('input:checked')).map(cb => cb.value);
          db.ref(`tasks/${sector}/${taskKey}/assignees`).set(sel.length ? sel : null);
          dropdown.remove();
        };
        dropdown.appendChild(done);
        document.body.appendChild(dropdown);

        const close = e => {
          if (!dropdown.contains(e.target) && e.target !== assignBtn) {
            dropdown.remove();
            document.removeEventListener('click', close);
          }
        };
        setTimeout(() => document.addEventListener('click', close), 0);
      };
      li.insertBefore(assignBtn, assigneesDiv);
    }

    document.getElementById(`tasks-${sector}`).appendChild(li);
  }

  // === –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–¥–∞—á–∏ –ë–ï–ó –ü–ï–†–ï–°–û–ó–î–ê–ù–ò–Ø ===
  function updateTask(sector, taskKey, data, li) {
    const inputs = li.querySelectorAll('input');
    const checkbox = inputs[0];
    const textInput = inputs[1];
    const assigneesDiv = li.querySelector('.task-assignees');

    if (checkbox) {
      checkbox.checked = data.done || false;
      checkbox.disabled = !isAdmin;
    }
    if (textInput) {
      textInput.disabled = !isAdmin;
      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –≤ —Ñ–æ–∫—É—Å–µ!
      if (document.activeElement !== textInput) {
        textInput.value = data.text || '';
      }
    }
    if (assigneesDiv) {
      if (data.assignees?.length > 0) {
        const names = data.assignees.map(k => participantsList.find(p => p.key === k)?.name || '???').join(', ');
        assigneesDiv.textContent = `–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏: ${names}`;
        assigneesDiv.style.color = '';
      } else {
        assigneesDiv.textContent = '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã';
        assigneesDiv.style.color = '#999';
      }
    }
  }

  // === –ù–∞–≤–∏–≥–∞—Ü–∏—è ===
  function switchTab(target) {
    document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));

    const btn = document.querySelector(`.sidebar button[data-target="${target}"]`);
    btn?.classList.add('active');
    document.getElementById(target)?.classList.add('active');

    localStorage.setItem(ACTIVE_TAB_KEY, target);
    currentTab = target;

    if (target.startsWith('sector-')) {
      const sector = target.split('-')[1];
      unsubscribeFromTasks(sector);
      document.getElementById(`tasks-${sector}`).innerHTML = '';
      const deleteBtn = document.querySelector('.delete-done-btn');
      if (deleteBtn) deleteBtn.remove();
      initTasks(sector);
    }
  }

  window.addNewParticipant = () => {
    if (!isAdmin) return enterAdminMode();
    const name = prompt("–ò–º—è:", "–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫");
    if (name?.trim()) db.ref('participants').push({ name: name.trim(), stars: 0, skulls: 0 });
  };

  window.addTask = (sector) => {
    if (!isAdmin) return enterAdminMode();
    const text = prompt("–ó–∞–¥–∞—á–∞:", "–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞");
    if (text?.trim()) db.ref(`tasks/${sector}`).push({ text: text.trim(), done: false, assignees: null });
  };

  document.addEventListener('DOMContentLoaded', async () => {
    await loadParticipants();
    document.querySelectorAll('.sidebar button').forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.target)));
    switchTab(currentTab);
    initParticipantsTable();
  });
</script>

</body>
</html>